#!/bin/bash
set -e

# Cores para interface
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# ConfiguraÃ§Ãµes globais
USERNAME=$(whoami)
MINECRAFT_DIR="$(pwd)/minecraft-servers-$USERNAME"
JAVA_8_URL="https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u392-b08/OpenJDK8U-jre_x64_linux_hotspot_8u392b08.tar.gz"
JAVA_17_URL="https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.9%2B9/OpenJDK17U-jre_x64_linux_hotspot_17.0.9_9.tar.gz"
USER_CONFIG_FILE="$MINECRAFT_DIR/.user_config"
SSH_TUNNELS_FILE="$MINECRAFT_DIR/.ssh_tunnels"

# FunÃ§Ã£o para exibir o logo
show_logo() {
    clear
    echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${PURPLE}â•‘                                                                              â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${GREEN}â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—${PURPLE}â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${GREEN}â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•${PURPLE}â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${GREEN}â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   ${PURPLE}â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${GREEN}â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   ${PURPLE}â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${GREEN}â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘   ${PURPLE}â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${GREEN}â•šâ•â•     â•šâ•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•        â•šâ•â•   ${PURPLE}â•‘${NC}"
    echo -e "${PURPLE}â•‘                                                                              â•‘${NC}"
    echo -e "${PURPLE}â•‘                    ${YELLOW}Multi-Platform Server Installer${PURPLE}                    â•‘${NC}"
    echo -e "${PURPLE}â•‘                           ${CYAN}VersÃ£o 2.0 - by Eric${PURPLE}                          â•‘${NC}"
    echo -e "${PURPLE}â•‘                      ${WHITE}ðŸ‘¤ UsuÃ¡rio: ${CYAN}$USERNAME${PURPLE}                      â•‘${NC}"
    echo -e "${PURPLE}â•‘                                                                              â•‘${NC}"
    echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

# FunÃ§Ã£o para pausar
pause() {
    echo -e "\n${YELLOW}Pressione ENTER para continuar...${NC}"
    read -r
}

# FunÃ§Ã£o para verificar dependÃªncias
check_dependencies() {
    echo -e "${CYAN}ðŸ” Verificando dependÃªncias para usuÃ¡rio $USERNAME...${NC}"
    
    # Verificar wget
    if ! command -v wget &> /dev/null; then
        echo -e "${YELLOW}âš ï¸  Instalando wget...${NC}"
        sudo apt update && sudo apt install -y wget
    fi
    
    # Verificar unzip
    if ! command -v unzip &> /dev/null; then
        echo -e "${YELLOW}âš ï¸  Instalando unzip...${NC}"
        sudo apt install -y unzip
    fi
    
    # Verificar tar
    if ! command -v tar &> /dev/null; then
        echo -e "${YELLOW}âš ï¸  Instalando tar...${NC}"
        sudo apt install -y tar
    fi
    
    # Criar diretÃ³rio principal do usuÃ¡rio
    mkdir -p "$MINECRAFT_DIR"
    
    # Criar arquivo de configuraÃ§Ã£o do usuÃ¡rio
    create_user_config
    
    echo -e "${GREEN}âœ… DependÃªncias verificadas para $USERNAME${NC}"
    echo -e "${CYAN}ðŸ“‚ DiretÃ³rio pessoal: $MINECRAFT_DIR${NC}"
}

# FunÃ§Ã£o para detectar IPs e configurar SSH
detect_network_info() {
    echo -e "${CYAN}ðŸŒ Detectando informaÃ§Ãµes de rede...${NC}"
    
    # IP local
    LOCAL_IP=$(hostname -I | awk '{print $1}' 2>/dev/null)
    if [ -z "$LOCAL_IP" ]; then
        LOCAL_IP=$(ip route get 8.8.8.8 2>/dev/null | awk '{print $7; exit}')
    fi
    
    # IP pÃºblico
    PUBLIC_IP=""
    echo -e "${CYAN}ðŸ” Detectando IP pÃºblico...${NC}"
    
    # Tentar vÃ¡rios serviÃ§os para obter IP pÃºblico
    PUBLIC_IP=$(curl -s --connect-timeout 5 ifconfig.me 2>/dev/null || \
                curl -s --connect-timeout 5 ipinfo.io/ip 2>/dev/null || \
                curl -s --connect-timeout 5 icanhazip.com 2>/dev/null || \
                wget -qO- --timeout=5 ifconfig.me 2>/dev/null)
    
    # Verificar se estamos em um ambiente SSH
    SSH_CONNECTION_INFO=""
    if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
        SSH_CONNECTION_INFO="Conectado via SSH"
        # Obter IP do cliente SSH
        SSH_CLIENT_IP=$(echo $SSH_CLIENT | awk '{print $1}')
        if [ -n "$SSH_CLIENT_IP" ]; then
            SSH_CONNECTION_INFO="SSH de: $SSH_CLIENT_IP"
        fi
    fi
    
    # Salvar informaÃ§Ãµes de rede no config
    {
        echo "LOCAL_IP=$LOCAL_IP"
        echo "PUBLIC_IP=$PUBLIC_IP"
        echo "SSH_CONNECTION=$SSH_CONNECTION_INFO"
        echo "LAST_NETWORK_CHECK=$(date '+%Y-%m-%d %H:%M:%S')"
    } >> "$USER_CONFIG_FILE"
    
    echo -e "${GREEN}âœ… InformaÃ§Ãµes de rede detectadas${NC}"
}

# FunÃ§Ã£o para configurar tÃºnel SSH reverso
setup_ssh_tunnel() {
    local server_name="$1"
    local local_port="$2"
    local server_type="$3"
    
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘        ${WHITE}CONFIGURAR TÃšNEL SSH${BLUE}           â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -e "${CYAN}ðŸŒ Configurando acesso pÃºblico para: $server_name${NC}"
    echo -e "${WHITE}Porta local: $local_port${NC}"
    echo
    
    echo -e "${YELLOW}Escolha o mÃ©todo de acesso pÃºblico:${NC}"
    echo -e "${WHITE}1)${NC} ${GREEN}TÃºnel SSH Reverso (Recomendado)${NC}"
    echo -e "${WHITE}2)${NC} ${CYAN}ServiÃ§os de Tunneling (ngrok/cloudflare)${NC}"
    echo -e "${WHITE}3)${NC} ${BLUE}Configurar Manualmente${NC}"
    echo -e "${WHITE}0)${NC} ${WHITE}Pular configuraÃ§Ã£o${NC}"
    echo
    echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
    read -r tunnel_choice
    
    case $tunnel_choice in
        1) setup_reverse_ssh_tunnel "$server_name" "$local_port" "$server_type" ;;
        2) setup_tunneling_service "$server_name" "$local_port" "$server_type" ;;
        3) show_manual_config "$server_name" "$local_port" "$server_type" ;;
        0) echo -e "${YELLOW}ConfiguraÃ§Ã£o de tÃºnel ignorada${NC}" ;;
        *) echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}" ;;
    esac
    
    pause
}

# FunÃ§Ã£o para configurar tÃºnel SSH reverso
setup_reverse_ssh_tunnel() {
    local server_name="$1"
    local local_port="$2"
    local server_type="$3"
    
    echo -e "${CYAN}ðŸ”§ Configurando tÃºnel SSH reverso...${NC}"
    echo
    
    echo -ne "${YELLOW}IP/hostname do servidor pÃºblico: ${NC}"
    read -r remote_host
    
    echo -ne "${YELLOW}UsuÃ¡rio SSH: ${NC}"
    read -r remote_user
    
    echo -ne "${YELLOW}Porta pÃºblica desejada (ou ENTER para automÃ¡tica): ${NC}"
    read -r remote_port
    
    if [ -z "$remote_port" ]; then
        remote_port=$((local_port + 1000))
        echo -e "${CYAN}Usando porta automÃ¡tica: $remote_port${NC}"
    fi
    
    echo -ne "${YELLOW}Porta SSH do servidor (22): ${NC}"
    read -r ssh_port
    ssh_port=${ssh_port:-22}
    
    # Criar comando do tÃºnel
    local tunnel_cmd="ssh -R $remote_port:localhost:$local_port -N -p $ssh_port $remote_user@$remote_host"
    
    echo -e "\n${CYAN}ðŸ” Testando conexÃ£o SSH...${NC}"
    if ssh -o ConnectTimeout=5 -o BatchMode=yes -p $ssh_port "$remote_user@$remote_host" exit 2>/dev/null; then
        echo -e "${GREEN}âœ… ConexÃ£o SSH estabelecida${NC}"
        
        # Salvar configuraÃ§Ã£o do tÃºnel
        local tunnel_info="$server_name|$local_port|$remote_host|$remote_user|$remote_port|$ssh_port|$server_type"
        echo "$tunnel_info" >> "$SSH_TUNNELS_FILE"
        
        # Criar script de tÃºnel
        local tunnel_script="$MINECRAFT_DIR/tunnel-$server_name.sh"
        cat > "$tunnel_script" << EOF
#!/bin/bash
echo "ðŸŒ Iniciando tÃºnel SSH para $server_name"
echo "Local: localhost:$local_port â†’ PÃºblico: $remote_host:$remote_port"
echo "Pressione Ctrl+C para parar o tÃºnel"
echo
$tunnel_cmd
EOF
        chmod +x "$tunnel_script"
        
        echo -e "\n${GREEN}âœ… TÃºnel SSH configurado com sucesso!${NC}"
        echo -e "${YELLOW}ðŸ“‹ InformaÃ§Ãµes de acesso:${NC}"
        echo -e "${WHITE}   â€¢ Servidor local: ${CYAN}localhost:$local_port${NC}"
        echo -e "${WHITE}   â€¢ Acesso pÃºblico: ${CYAN}$remote_host:$remote_port${NC}"
        echo -e "${WHITE}   â€¢ Script do tÃºnel: ${CYAN}$tunnel_script${NC}"
        echo
        echo -e "${BLUE}ðŸ’¡ Para ativar o tÃºnel:${NC}"
        echo -e "${WHITE}   1. Inicie seu servidor Minecraft${NC}"
        echo -e "${WHITE}   2. Execute: ${CYAN}$tunnel_script${NC}"
        echo -e "${WHITE}   3. Conecte usando: ${CYAN}$remote_host:$remote_port${NC}"
        
    else
        echo -e "${RED}âŒ Erro ao conectar via SSH${NC}"
        echo -e "${YELLOW}Verifique:${NC}"
        echo -e "${WHITE}   â€¢ Credenciais SSH corretas${NC}"
        echo -e "${WHITE}   â€¢ Servidor acessÃ­vel${NC}"
        echo -e "${WHITE}   â€¢ Porta SSH correta${NC}"
    fi
}

# FunÃ§Ã£o para configurar serviÃ§os de tunneling
setup_tunneling_service() {
    local server_name="$1"
    local local_port="$2"
    local server_type="$3"
    
    echo -e "${CYAN}ðŸš€ Configurando serviÃ§o de tunneling...${NC}"
    echo
    
    echo -e "${YELLOW}ServiÃ§os disponÃ­veis:${NC}"
    echo -e "${WHITE}1)${NC} ${GREEN}ngrok (Gratuito com limitaÃ§Ãµes)${NC}"
    echo -e "${WHITE}2)${NC} ${BLUE}Cloudflare Tunnel (Gratuito)${NC}"
    echo -e "${WHITE}3)${NC} ${PURPLE}LocalTunnel (Gratuito)${NC}"
    echo
    echo -ne "${YELLOW}Escolha um serviÃ§o: ${NC}"
    read -r service_choice
    
    case $service_choice in
        1) setup_ngrok "$server_name" "$local_port" "$server_type" ;;
        2) setup_cloudflare_tunnel "$server_name" "$local_port" "$server_type" ;;
        3) setup_localtunnel "$server_name" "$local_port" "$server_type" ;;
        *) echo -e "${RED}OpÃ§Ã£o invÃ¡lida${NC}" ;;
    esac
}

# FunÃ§Ã£o para configurar ngrok
setup_ngrok() {
    local server_name="$1"
    local local_port="$2"
    local server_type="$3"
    
    echo -e "${CYAN}ðŸ“¦ Configurando ngrok...${NC}"
    
    # Verificar se ngrok estÃ¡ instalado
    if ! command -v ngrok &> /dev/null; then
        echo -e "${YELLOW}âš ï¸  ngrok nÃ£o encontrado. Instalando...${NC}"
        
        # Download ngrok
        local ngrok_url="https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz"
        wget -O /tmp/ngrok.tgz "$ngrok_url" 2>/dev/null || {
            echo -e "${RED}âŒ Erro ao baixar ngrok${NC}"
            return 1
        }
        
        # Instalar ngrok
        mkdir -p "$MINECRAFT_DIR/tools"
        tar -xzf /tmp/ngrok.tgz -C "$MINECRAFT_DIR/tools"
        rm /tmp/ngrok.tgz
        
        # Adicionar ao PATH temporariamente
        export PATH="$MINECRAFT_DIR/tools:$PATH"
    fi
    
    echo -e "${YELLOW}ðŸ”‘ Para usar ngrok, vocÃª precisa de um token (gratuito)${NC}"
    echo -e "${WHITE}1. Acesse: ${CYAN}https://ngrok.com/signup${NC}"
    echo -e "${WHITE}2. FaÃ§a login e copie seu authtoken${NC}"
    echo
    echo -ne "${YELLOW}Cole seu authtoken do ngrok: ${NC}"
    read -r ngrok_token
    
    if [ -n "$ngrok_token" ]; then
        # Configurar ngrok
        "$MINECRAFT_DIR/tools/ngrok" authtoken "$ngrok_token" || ngrok authtoken "$ngrok_token"
        
        # Criar script para tunnel ngrok
        local tunnel_script="$MINECRAFT_DIR/ngrok-$server_name.sh"
        cat > "$tunnel_script" << EOF
#!/bin/bash
echo "ðŸŒ Iniciando tÃºnel ngrok para $server_name"
echo "Porta local: $local_port"
echo "Pressione Ctrl+C para parar"
echo

# Usar ngrok do diretÃ³rio tools se estiver disponÃ­vel
if [ -f "$MINECRAFT_DIR/tools/ngrok" ]; then
    "$MINECRAFT_DIR/tools/ngrok" tcp $local_port
else
    ngrok tcp $local_port
fi
EOF
        chmod +x "$tunnel_script"
        
        echo -e "\n${GREEN}âœ… ngrok configurado com sucesso!${NC}"
        echo -e "${YELLOW}ðŸ“‹ Como usar:${NC}"
        echo -e "${WHITE}   1. Inicie seu servidor Minecraft${NC}"
        echo -e "${WHITE}   2. Execute: ${CYAN}$tunnel_script${NC}"
        echo -e "${WHITE}   3. Copie o endereÃ§o TCP fornecido pelo ngrok${NC}"
        echo -e "${WHITE}   4. Use esse endereÃ§o para conectar${NC}"
    fi
}

# FunÃ§Ã£o para configurar Cloudflare Tunnel
setup_cloudflare_tunnel() {
    local server_name="$1"
    local local_port="$2"
    local server_type="$3"
    
    echo -e "${CYAN}â˜ï¸  Configurando Cloudflare Tunnel...${NC}"
    echo
    
    echo -e "${YELLOW}Para usar Cloudflare Tunnel:${NC}"
    echo -e "${WHITE}1. Instale cloudflared: ${CYAN}curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb${NC}"
    echo -e "${WHITE}2. Autentique: ${CYAN}cloudflared tunnel login${NC}"
    echo -e "${WHITE}3. Crie um tÃºnel: ${CYAN}cloudflared tunnel create $server_name${NC}"
    echo -e "${WHITE}4. Configure o tÃºnel para a porta $local_port${NC}"
    echo
    
    # Criar script bÃ¡sico
    local tunnel_script="$MINECRAFT_DIR/cloudflare-$server_name.sh"
    cat > "$tunnel_script" << EOF
#!/bin/bash
echo "â˜ï¸  Iniciando Cloudflare Tunnel para $server_name"
echo "Certifique-se de ter configurado o cloudflared primeiro"
echo

# Substitua TUNNEL_ID pelo ID do seu tÃºnel
# cloudflared tunnel run --url tcp://localhost:$local_port TUNNEL_ID
echo "Execute: cloudflared tunnel run --url tcp://localhost:$local_port SEU_TUNNEL_ID"
EOF
    chmod +x "$tunnel_script"
    
    echo -e "${GREEN}Script criado: $tunnel_script${NC}"
}

# FunÃ§Ã£o para configurar LocalTunnel
setup_localtunnel() {
    local server_name="$1"
    local local_port="$2"
    local server_type="$3"
    
    echo -e "${CYAN}ðŸ”— Configurando LocalTunnel...${NC}"
    
    # Verificar Node.js
    if ! command -v npm &> /dev/null; then
        echo -e "${YELLOW}âš ï¸  Node.js/npm nÃ£o encontrado${NC}"
        echo -e "${WHITE}Instale Node.js primeiro: ${CYAN}https://nodejs.org${NC}"
        return 1
    fi
    
    # Instalar localtunnel
    echo -e "${CYAN}ðŸ“¦ Instalando localtunnel...${NC}"
    npm install -g localtunnel 2>/dev/null || {
        echo -e "${RED}âŒ Erro ao instalar localtunnel${NC}"
        return 1
    }
    
    # Criar script para tunnel
    local tunnel_script="$MINECRAFT_DIR/localtunnel-$server_name.sh"
    cat > "$tunnel_script" << EOF
#!/bin/bash
echo "ðŸ”— Iniciando LocalTunnel para $server_name"
echo "Porta: $local_port"
echo "Pressione Ctrl+C para parar"
echo

lt --port $local_port --subdomain minecraft-$server_name-$USERNAME
EOF
    chmod +x "$tunnel_script"
    
    echo -e "\n${GREEN}âœ… LocalTunnel configurado!${NC}"
    echo -e "${WHITE}Script: ${CYAN}$tunnel_script${NC}"
}

# FunÃ§Ã£o para mostrar configuraÃ§Ã£o manual
show_manual_config() {
    local server_name="$1"
    local local_port="$2"
    local server_type="$3"
    
    echo -e "${CYAN}ðŸ“‹ ConfiguraÃ§Ã£o Manual de Acesso PÃºblico${NC}"
    echo
    
    echo -e "${YELLOW}OpÃ§Ãµes para acesso pÃºblico:${NC}"
    echo
    
    echo -e "${WHITE}1ï¸âƒ£  Port Forwarding no Roteador:${NC}"
    echo -e "${WHITE}   â€¢ Acesse o painel do seu roteador${NC}"
    echo -e "${WHITE}   â€¢ Configure port forwarding:${NC}"
    echo -e "${WHITE}     - Porta externa: $local_port${NC}"
    echo -e "${WHITE}     - Porta interna: $local_port${NC}"
    echo -e "${WHITE}     - IP interno: $LOCAL_IP${NC}"
    echo
    
    echo -e "${WHITE}2ï¸âƒ£  VPS/Servidor na Nuvem:${NC}"
    echo -e "${WHITE}   â€¢ Use um servidor VPS${NC}"
    echo -e "${WHITE}   â€¢ Configure tÃºnel SSH reverso${NC}"
    echo -e "${WHITE}   â€¢ Comando: ${CYAN}ssh -R $local_port:localhost:$local_port usuario@vps${NC}"
    echo
    
    echo -e "${WHITE}3ï¸âƒ£  ServiÃ§os de Cloud Gaming:${NC}"
    echo -e "${WHITE}   â€¢ AWS GameLift${NC}"
    echo -e "${WHITE}   â€¢ Google Cloud Game Servers${NC}"
    echo -e "${WHITE}   â€¢ Azure PlayFab${NC}"
    echo
    
    echo -e "${WHITE}ðŸ”§ Seu servidor atual:${NC}"
    echo -e "${WHITE}   â€¢ Nome: $server_name${NC}"
    echo -e "${WHITE}   â€¢ Porta: $local_port${NC}"
    echo -e "${WHITE}   â€¢ IP local: $LOCAL_IP${NC}"
    echo -e "${WHITE}   â€¢ IP pÃºblico: $PUBLIC_IP${NC}"
}

# FunÃ§Ã£o para obter prÃ³xima porta disponÃ­vel
get_next_port() {
    local base_port=25565
    local user_offset=$(($(id -u) % 1000))  # Usar UID como offset Ãºnico
    local last_port=$(grep "LAST_PORT_USED=" "$USER_CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 || echo $base_port)
    
    # Calcular porta base Ãºnica para o usuÃ¡rio
    local user_base_port=$((base_port + user_offset))
    
    # Se a Ãºltima porta usada for menor que a base do usuÃ¡rio, usar a base
    if [ "$last_port" -lt "$user_base_port" ]; then
        last_port=$user_base_port
    fi
    
    # Procurar prÃ³xima porta livre
    local test_port=$((last_port + 1))
    while netstat -ln 2>/dev/null | grep -q ":$test_port "; do
        ((test_port++))
    done
    
    # Atualizar Ãºltima porta usada
    sed -i "s/LAST_PORT_USED=.*/LAST_PORT_USED=$test_port/" "$USER_CONFIG_FILE"
    
    echo $test_port
}

# FunÃ§Ã£o para incrementar contador de servidores
increment_server_count() {
    local current_count=$(grep "TOTAL_SERVERS=" "$USER_CONFIG_FILE" | cut -d'=' -f2)
    local new_count=$((current_count + 1))
    sed -i "s/TOTAL_SERVERS=.*/TOTAL_SERVERS=$new_count/" "$USER_CONFIG_FILE"
}

# FunÃ§Ã£o para instalar Java
install_java() {
    local java_version="$1"
    local java_dir="$MINECRAFT_DIR/java${java_version}"
    
    if [ -d "$java_dir" ]; then
        echo -e "${GREEN}âœ… Java $java_version jÃ¡ instalado${NC}"
        return 0
    fi
    
    echo -e "${CYAN}ðŸ“¦ Instalando Java $java_version...${NC}"
    mkdir -p "$java_dir"
    
    if [ "$java_version" = "8" ]; then
        wget -O /tmp/java8.tar.gz "$JAVA_8_URL" || {
            echo -e "${RED}âŒ Erro ao baixar Java 8${NC}"
            return 1
        }
        tar -xzf /tmp/java8.tar.gz -C "$java_dir" --strip-components=1
    elif [ "$java_version" = "17" ]; then
        wget -O /tmp/java17.tar.gz "$JAVA_17_URL" || {
            echo -e "${RED}âŒ Erro ao baixar Java 17${NC}"
            return 1
        }
        tar -xzf /tmp/java17.tar.gz -C "$java_dir" --strip-components=1
    fi
    
    rm -f /tmp/java*.tar.gz
    echo -e "${GREEN}âœ… Java $java_version instalado${NC}"
}

# FunÃ§Ã£o para criar servidor Vanilla
create_vanilla_server() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘         ${WHITE}SERVIDOR MINECRAFT VANILLA${BLUE}      â•‘${NC}"
    echo -e "${BLUE}â•‘              ${CYAN}UsuÃ¡rio: $USERNAME${BLUE}             â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -ne "${YELLOW}Nome do seu servidor: ${NC}"
    read -r server_name
    
    # Validar nome do servidor
    if [[ ! "$server_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}âŒ Nome invÃ¡lido! Use apenas letras, nÃºmeros, _ e -${NC}"
        pause
        return 1
    fi
    
    echo -ne "${YELLOW}VersÃ£o do Minecraft (ex: 1.20.4): ${NC}"
    read -r mc_version
    
    # Sugerir porta Ãºnica para o usuÃ¡rio
    local suggested_port=$(get_next_port)
    echo -ne "${YELLOW}Porta do servidor ($suggested_port): ${NC}"
    read -r server_port
    server_port=${server_port:-$suggested_port}
    
    echo -ne "${YELLOW}RAM para o servidor (2048M): ${NC}"
    read -r server_ram
    server_ram=${server_ram:-2048M}
    
    # Criar servidor com ID Ãºnico do usuÃ¡rio
    local server_dir="$MINECRAFT_DIR/vanilla-$server_name-$(date +%s)"
    mkdir -p "$server_dir"
    
    # Instalar Java 17
    install_java "17"
    
    # Baixar servidor
    echo -e "${CYAN}ðŸ“¦ Baixando servidor Vanilla $mc_version para $USERNAME...${NC}"
    local jar_url="https://papermc.io/api/v2/projects/paper/versions/$mc_version/builds"
    local latest_build=$(wget -qO- "$jar_url" | grep -o '"build":[0-9]*' | tail -1 | cut -d':' -f2)
    
    if [ -z "$latest_build" ]; then
        echo -e "${RED}âŒ VersÃ£o nÃ£o encontrada. Usando servidor oficial...${NC}"
        wget -O "$server_dir/server.jar" "https://launcher.mojang.com/v1/objects/$(wget -qO- "https://launchermeta.mojang.com/mc/game/version_manifest.json" | grep -A 10 "\"id\": \"$mc_version\"" | grep -o '"url": "[^"]*"' | head -1 | cut -d'"' -f4 | xargs wget -qO- | grep -o '"server": {"url": "[^"]*"' | cut -d'"' -f6)/server.jar" || {
            echo -e "${RED}âŒ Erro ao baixar servidor${NC}"
            return 1
        }
    else
        wget -O "$server_dir/server.jar" "https://papermc.io/api/v2/projects/paper/versions/$mc_version/builds/$latest_build/downloads/paper-$mc_version-$latest_build.jar" || {
            echo -e "${RED}âŒ Erro ao baixar Paper. Tentando servidor oficial...${NC}"
            wget -O "$server_dir/server.jar" "https://launcher.mojang.com/v1/objects/server.jar"
        }
    fi
    
    # Criar configuraÃ§Ãµes
    create_server_configs "$server_dir" "$server_port" "$server_name" "$USERNAME"
    
    # Criar script de inicializaÃ§Ã£o
    cat > "$server_dir/start.sh" << EOF
#!/bin/bash
cd "\$(dirname "\$0")"
export PATH="$MINECRAFT_DIR/java17/bin:\$PATH"
echo "Iniciando servidor de $USERNAME: $server_name"
echo "Porta: $server_port | RAM: $server_ram"
java -Xmx$server_ram -Xms1024M -jar server.jar nogui
EOF
    
    chmod +x "$server_dir/start.sh"
    
    # Criar arquivo de informaÃ§Ãµes do servidor
    cat > "$server_dir/server_info.txt" << EOF
# InformaÃ§Ãµes do Servidor
OWNER=$USERNAME
SERVER_NAME=$server_name
SERVER_TYPE=vanilla
MC_VERSION=$mc_version
SERVER_PORT=$server_port
SERVER_RAM=$server_ram
CREATED_DATE=$(date '+%Y-%m-%d %H:%M:%S')
LOCATION=$server_dir
EOF
    
    # Incrementar contador
    increment_server_count
    
    # Perguntar sobre configuraÃ§Ã£o de acesso pÃºblico
    echo -e "\n${CYAN}ðŸŒ Configurar acesso pÃºblico para o servidor?${NC}"
    echo -ne "${YELLOW}Configurar tÃºnel SSH ou acesso externo? (y/N): ${NC}"
    read -r setup_public
    
    if [[ $setup_public =~ ^[Yy]$ ]]; then
        setup_ssh_tunnel "$server_name" "$server_port" "vanilla"
    fi
    
    echo -e "\n${GREEN}âœ… Servidor Vanilla criado com sucesso para $USERNAME!${NC}"
    echo -e "${YELLOW}ðŸ“‹ InformaÃ§Ãµes do seu servidor:${NC}"
    echo -e "${WHITE}   â€¢ ProprietÃ¡rio: ${CYAN}$USERNAME${NC}"
    echo -e "${WHITE}   â€¢ Nome: ${CYAN}$server_name${NC}"
    echo -e "${WHITE}   â€¢ VersÃ£o: ${CYAN}$mc_version${NC}"
    echo -e "${WHITE}   â€¢ Porta local: ${CYAN}$server_port${NC}"
    echo -e "${WHITE}   â€¢ RAM: ${CYAN}$server_ram${NC}"
    echo -e "${WHITE}   â€¢ LocalizaÃ§Ã£o: ${CYAN}$server_dir${NC}"
    echo -e "${WHITE}   â€¢ Iniciar: ${CYAN}./start.sh${NC}"
    
    # Mostrar informaÃ§Ãµes de rede
    echo -e "\n${CYAN}ðŸŒ InformaÃ§Ãµes de Rede:${NC}"
    echo -e "${WHITE}   â€¢ IP local: ${CYAN}$LOCAL_IP:$server_port${NC}"
    if [ -n "$PUBLIC_IP" ]; then
        echo -e "${WHITE}   â€¢ IP pÃºblico: ${CYAN}$PUBLIC_IP:$server_port${NC} ${YELLOW}(requer port forwarding)${NC}"
    fi
    if [ -n "$SSH_CONNECTION_INFO" ]; then
        echo -e "${WHITE}   â€¢ ConexÃ£o SSH: ${CYAN}$SSH_CONNECTION_INFO${NC}"
    fi
    echo
    echo -e "${BLUE}ðŸ’¡ Seu servidor Ã© privado e isolado de outros usuÃ¡rios!${NC}"
    
    pause
}

# FunÃ§Ã£o para criar servidor PocketMine
create_pocketmine_server() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘         ${WHITE}SERVIDOR POCKETMINE-MP${BLUE}         â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -ne "${YELLOW}Nome do servidor: ${NC}"
    read -r server_name
    
    echo -ne "${YELLOW}Porta do servidor (19132): ${NC}"
    read -r server_port
    server_port=${server_port:-19132}
    
    local server_dir="$MINECRAFT_DIR/pocketmine-$server_name"
    mkdir -p "$server_dir"
    
    # Baixar PocketMine-MP
    echo -e "${CYAN}ðŸ“¦ Baixando PocketMine-MP...${NC}"
    wget -O "$server_dir/PocketMine-MP.phar" "https://github.com/pmmp/PocketMine-MP/releases/latest/download/PocketMine-MP.phar" || {
        echo -e "${RED}âŒ Erro ao baixar PocketMine-MP${NC}"
        return 1
    }
    
    # Baixar PHP binÃ¡rio para PocketMine
    echo -e "${CYAN}ðŸ“¦ Baixando PHP para PocketMine...${NC}"
    local php_url="https://github.com/pmmp/PHP-Binaries/releases/latest/download/PHP-Linux-x86_64.tar.gz"
    wget -O /tmp/php-pocketmine.tar.gz "$php_url" || {
        echo -e "${RED}âŒ Erro ao baixar PHP${NC}"
        return 1
    }
    
    tar -xzf /tmp/php-pocketmine.tar.gz -C "$server_dir"
    rm -f /tmp/php-pocketmine.tar.gz
    
    # Criar configuraÃ§Ã£o do servidor
    cat > "$server_dir/server.properties" << EOF
motd=$server_name
server-port=$server_port
white-list=off
announce-player-achievements=on
spawn-protection=16
max-players=20
gamemode=0
force-gamemode=off
hardcore=off
pvp=on
difficulty=1
generator-settings=
level-name=world
level-seed=
level-type=DEFAULT
enable-query=on
enable-rcon=off
enable-command-block=off
EOF
    
    # Criar script de inicializaÃ§Ã£o
    cat > "$server_dir/start.sh" << EOF
#!/bin/bash
cd "\$(dirname "\$0")"
./bin/php7/bin/php PocketMine-MP.phar
EOF
    
    chmod +x "$server_dir/start.sh"
    
    echo -e "\n${GREEN}âœ… Servidor PocketMine-MP criado com sucesso!${NC}"
    echo -e "${YELLOW}ðŸ“‹ InformaÃ§Ãµes do servidor:${NC}"
    echo -e "${WHITE}   â€¢ Nome: ${CYAN}$server_name${NC}"
    echo -e "${WHITE}   â€¢ Tipo: ${CYAN}PocketMine-MP (Bedrock)${NC}"
    echo -e "${WHITE}   â€¢ Porta: ${CYAN}$server_port${NC}"
    echo -e "${WHITE}   â€¢ LocalizaÃ§Ã£o: ${CYAN}$server_dir${NC}"
    echo -e "${WHITE}   â€¢ Iniciar: ${CYAN}./start.sh${NC}"
    
    pause
}

# FunÃ§Ã£o para criar servidor Nukkit
create_nukkit_server() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘           ${WHITE}SERVIDOR NUKKIT${BLUE}              â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -ne "${YELLOW}Nome do servidor: ${NC}"
    read -r server_name
    
    echo -ne "${YELLOW}Porta do servidor (19132): ${NC}"
    read -r server_port
    server_port=${server_port:-19132}
    
    echo -ne "${YELLOW}RAM para o servidor (1024M): ${NC}"
    read -r server_ram
    server_ram=${server_ram:-1024M}
    
    local server_dir="$MINECRAFT_DIR/nukkit-$server_name"
    mkdir -p "$server_dir"
    
    # Instalar Java 8
    install_java "8"
    
    # Baixar Nukkit
    echo -e "${CYAN}ðŸ“¦ Baixando Nukkit...${NC}"
    wget -O "$server_dir/nukkit.jar" "https://ci.opencollab.dev/job/NukkitX/job/Nukkit/job/master/lastSuccessfulBuild/artifact/target/nukkit-1.0-SNAPSHOT.jar" || {
        echo -e "${YELLOW}âš ï¸  Tentando build alternativo...${NC}"
        wget -O "$server_dir/nukkit.jar" "https://github.com/CloudburstMC/Nukkit/releases/latest/download/nukkit.jar" || {
            echo -e "${RED}âŒ Erro ao baixar Nukkit${NC}"
            return 1
        }
    }
    
    # Criar configuraÃ§Ã£o do servidor
    cat > "$server_dir/server.properties" << EOF
motd=$server_name
server-port=$server_port
white-list=off
announce-player-achievements=on
spawn-protection=16
max-players=20
gamemode=0
force-gamemode=off
hardcore=off
pvp=on
difficulty=1
generator-settings=
level-name=world
level-seed=
level-type=DEFAULT
enable-query=on
enable-rcon=off
view-distance=10
EOF
    
    # Criar script de inicializaÃ§Ã£o
    cat > "$server_dir/start.sh" << EOF
#!/bin/bash
cd "\$(dirname "\$0")"
export PATH="$MINECRAFT_DIR/java8/bin:\$PATH"
java -Xmx$server_ram -Xms512M -jar nukkit.jar
EOF
    
    chmod +x "$server_dir/start.sh"
    
    echo -e "\n${GREEN}âœ… Servidor Nukkit criado com sucesso!${NC}"
    echo -e "${YELLOW}ðŸ“‹ InformaÃ§Ãµes do servidor:${NC}"
    echo -e "${WHITE}   â€¢ Nome: ${CYAN}$server_name${NC}"
    echo -e "${WHITE}   â€¢ Tipo: ${CYAN}Nukkit (Bedrock)${NC}"
    echo -e "${WHITE}   â€¢ Porta: ${CYAN}$server_port${NC}"
    echo -e "${WHITE}   â€¢ RAM: ${CYAN}$server_ram${NC}"
    echo -e "${WHITE}   â€¢ LocalizaÃ§Ã£o: ${CYAN}$server_dir${NC}"
    echo -e "${WHITE}   â€¢ Iniciar: ${CYAN}./start.sh${NC}"
    
    pause
}

# FunÃ§Ã£o para criar servidor Forge
create_forge_server() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘          ${WHITE}SERVIDOR MINECRAFT FORGE${BLUE}       â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -ne "${YELLOW}Nome do servidor: ${NC}"
    read -r server_name
    
    echo -ne "${YELLOW}VersÃ£o do Minecraft (ex: 1.20.1): ${NC}"
    read -r mc_version
    
    echo -ne "${YELLOW}VersÃ£o do Forge (pressione ENTER para a mais recente): ${NC}"
    read -r forge_version
    
    echo -ne "${YELLOW}Porta do servidor (25565): ${NC}"
    read -r server_port
    server_port=${server_port:-25565}
    
    echo -ne "${YELLOW}RAM para o servidor (4096M): ${NC}"
    read -r server_ram
    server_ram=${server_ram:-4096M}
    
    local server_dir="$MINECRAFT_DIR/forge-$server_name"
    mkdir -p "$server_dir"
    
    # Instalar Java 17
    install_java "17"
    
    # Determinar versÃ£o do Forge
    if [ -z "$forge_version" ]; then
        echo -e "${CYAN}ðŸ” Buscando Ãºltima versÃ£o do Forge para $mc_version...${NC}"
        forge_version=$(wget -qO- "https://files.minecraftforge.net/net/minecraftforge/forge/promotions_slim.json" | grep -o "\"$mc_version-[^\"]*" | head -1 | cut -d'"' -f2)
        
        if [ -z "$forge_version" ]; then
            echo -e "${RED}âŒ VersÃ£o do Forge nÃ£o encontrada para $mc_version${NC}"
            return 1
        fi
    fi
    
    # Baixar instalador do Forge
    echo -e "${CYAN}ðŸ“¦ Baixando Forge $forge_version...${NC}"
    local forge_url="https://maven.minecraftforge.net/net/minecraftforge/forge/$forge_version/forge-$forge_version-installer.jar"
    wget -O "$server_dir/forge-installer.jar" "$forge_url" || {
        echo -e "${RED}âŒ Erro ao baixar Forge${NC}"
        return 1
    }
    
    # Instalar servidor Forge
    echo -e "${CYAN}ðŸ”§ Instalando servidor Forge...${NC}"
    cd "$server_dir"
    export PATH="$MINECRAFT_DIR/java17/bin:$PATH"
    java -jar forge-installer.jar --installServer || {
        echo -e "${RED}âŒ Erro ao instalar servidor Forge${NC}"
        return 1
    }
    
    # Encontrar o JAR do servidor
    local server_jar=$(find . -name "forge-*-server.jar" -o -name "minecraft_server*.jar" | head -1)
    if [ -z "$server_jar" ]; then
        server_jar="server.jar"
    fi
    
    # Aceitar EULA
    echo "eula=true" > eula.txt
    
    # Criar configuraÃ§Ãµes
    create_server_configs "$server_dir" "$server_port" "$server_name"
    
    # Criar script de inicializaÃ§Ã£o
    cat > "$server_dir/start.sh" << EOF
#!/bin/bash
cd "\$(dirname "\$0")"
export PATH="$MINECRAFT_DIR/java17/bin:\$PATH"
java -Xmx$server_ram -Xms1024M -jar $server_jar nogui
EOF
    
    chmod +x "$server_dir/start.sh"
    
    # Criar pasta de mods
    mkdir -p "$server_dir/mods"
    echo "# Coloque seus mods (.jar) nesta pasta" > "$server_dir/mods/README.txt"
    
    echo -e "\n${GREEN}âœ… Servidor Forge criado com sucesso!${NC}"
    echo -e "${YELLOW}ðŸ“‹ InformaÃ§Ãµes do servidor:${NC}"
    echo -e "${WHITE}   â€¢ Nome: ${CYAN}$server_name${NC}"
    echo -e "${WHITE}   â€¢ VersÃ£o MC: ${CYAN}$mc_version${NC}"
    echo -e "${WHITE}   â€¢ VersÃ£o Forge: ${CYAN}$forge_version${NC}"
    echo -e "${WHITE}   â€¢ Porta: ${CYAN}$server_port${NC}"
    echo -e "${WHITE}   â€¢ RAM: ${CYAN}$server_ram${NC}"
    echo -e "${WHITE}   â€¢ LocalizaÃ§Ã£o: ${CYAN}$server_dir${NC}"
    echo -e "${WHITE}   â€¢ Mods: ${CYAN}$server_dir/mods/${NC}"
    echo -e "${WHITE}   â€¢ Iniciar: ${CYAN}./start.sh${NC}"
    
    pause
}

# FunÃ§Ã£o para criar servidor Bedrock oficial
create_bedrock_server() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘        ${WHITE}SERVIDOR BEDROCK OFICIAL${BLUE}        â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -ne "${YELLOW}Nome do servidor: ${NC}"
    read -r server_name
    
    echo -ne "${YELLOW}Porta do servidor (19132): ${NC}"
    read -r server_port
    server_port=${server_port:-19132}
    
    local server_dir="$MINECRAFT_DIR/bedrock-$server_name"
    mkdir -p "$server_dir"
    
    # Baixar servidor Bedrock
    echo -e "${CYAN}ðŸ“¦ Baixando servidor Bedrock oficial...${NC}"
    local bedrock_url="https://minecraft.azureedge.net/bin-linux/bedrock-server-$(wget -qO- 'https://www.minecraft.net/en-us/download/server/bedrock' | grep -o 'bedrock-server-[0-9.]*\.zip' | head -1 | cut -d'-' -f3)"
    
    if [[ "$bedrock_url" == *"bedrock-server-.zip" ]]; then
        # Fallback para versÃ£o conhecida
        bedrock_url="https://minecraft.azureedge.net/bin-linux/bedrock-server-1.20.51.01.zip"
    fi
    
    wget -O "$server_dir/bedrock-server.zip" "$bedrock_url" || {
        echo -e "${RED}âŒ Erro ao baixar servidor Bedrock${NC}"
        return 1
    }
    
    # Extrair servidor
    cd "$server_dir"
    unzip -o bedrock-server.zip
    rm bedrock-server.zip
    
    # Tornar o servidor executÃ¡vel
    chmod +x bedrock_server
    
    # Configurar servidor
    sed -i "s/server-name=.*/server-name=$server_name/" server.properties
    sed -i "s/server-port=.*/server-port=$server_port/" server.properties
    sed -i "s/max-players=.*/max-players=20/" server.properties
    sed -i "s/gamemode=.*/gamemode=survival/" server.properties
    sed -i "s/difficulty=.*/difficulty=easy/" server.properties
    
    # Criar script de inicializaÃ§Ã£o
    cat > "$server_dir/start.sh" << 'EOF'
#!/bin/bash
cd "$(dirname "$0")"
export LD_LIBRARY_PATH=.
./bedrock_server
EOF
    
    chmod +x "$server_dir/start.sh"
    
    echo -e "\n${GREEN}âœ… Servidor Bedrock criado com sucesso!${NC}"
    echo -e "${YELLOW}ðŸ“‹ InformaÃ§Ãµes do servidor:${NC}"
    echo -e "${WHITE}   â€¢ Nome: ${CYAN}$server_name${NC}"
    echo -e "${WHITE}   â€¢ Tipo: ${CYAN}Bedrock Oficial${NC}"
    echo -e "${WHITE}   â€¢ Porta: ${CYAN}$server_port${NC}"
    echo -e "${WHITE}   â€¢ LocalizaÃ§Ã£o: ${CYAN}$server_dir${NC}"
    echo -e "${WHITE}   â€¢ Iniciar: ${CYAN}./start.sh${NC}"
    
    pause
}

# FunÃ§Ã£o para criar configuraÃ§Ãµes bÃ¡sicas do servidor
create_server_configs() {
    local server_dir="$1"
    local server_port="$2"
    local server_name="$3"
    local owner="$4"
    
    # server.properties com identificaÃ§Ã£o do proprietÃ¡rio
    cat > "$server_dir/server.properties" << EOF
# Servidor Minecraft - ProprietÃ¡rio: $owner
# Criado em: $(date)
enable-jmx-monitoring=false
rcon.port=25575
level-seed=
gamemode=survival
enable-command-block=false
enable-query=false
generator-settings=
level-name=world-$owner
motd=$server_name (Owner: $owner)
query.port=$server_port
pvp=true
generate-structures=true
difficulty=easy
network-compression-threshold=256
max-tick-time=60000
require-resource-pack=false
use-native-transport=true
max-players=20
online-mode=true
enable-status=true
allow-flight=false
broadcast-rcon-to-ops=true
view-distance=10
server-ip=
resource-pack-prompt=
allow-nether=true
server-port=$server_port
enable-rcon=false
sync-chunk-writes=true
op-permission-level=4
prevent-proxy-connections=false
hide-online-players=false
resource-pack=
entity-broadcast-range-percentage=100
simulation-distance=10
rcon.password=
player-idle-timeout=0
debug=false
force-gamemode=false
rate-limit=0
hardcore=false
white-list=false
broadcast-console-to-ops=true
spawn-npcs=true
spawn-animals=true
snooper-enabled=true
function-permission-level=2
level-type=default
text-filtering-config=
spawn-monsters=true
enforce-whitelist=false
spawn-protection=16
resource-pack-sha1=
max-world-size=29999984
EOF
    
    # eula.txt
    echo "eula=true" > "$server_dir/eula.txt"
    
    # ops.json (vazio inicialmente)
    echo "[]" > "$server_dir/ops.json"
    
    # whitelist.json (vazio inicialmente)  
    echo "[]" > "$server_dir/whitelist.json"
    
    # Criar arquivo README personalizado
    cat > "$server_dir/README.txt" << EOF
===========================================
SERVIDOR MINECRAFT - PROPRIETÃRIO: $owner
===========================================

Nome do Servidor: $server_name
ProprietÃ¡rio: $owner
Criado em: $(date)
Porta: $server_port

COMO USAR:
1. Para iniciar o servidor: ./start.sh
2. Para parar: Ctrl+C no terminal ou kill <PID>
3. Para conectar: use o IP do servidor e porta $server_port

ARQUIVOS IMPORTANTES:
- server.properties: ConfiguraÃ§Ãµes do servidor
- ops.json: Lista de operadores
- whitelist.json: Lista de jogadores permitidos
- world-$owner/: Pasta do mundo (privada)

IMPORTANTE: Este servidor Ã© privado e isolado.
Apenas vocÃª ($owner) pode gerenciÃ¡-lo.
===========================================
EOF
}

# FunÃ§Ã£o para listar servidores
list_servers() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘           ${WHITE}SERVIDORES CRIADOS${BLUE}            â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    if [ ! -d "$MINECRAFT_DIR" ] || [ -z "$(ls -A "$MINECRAFT_DIR" 2>/dev/null | grep -E '^(vanilla|pocketmine|nukkit|forge|bedrock)-')" ]; then
        echo -e "${YELLOW}ðŸ“­ Nenhum servidor encontrado${NC}"
        pause
        return
    fi
    
    echo -e "${CYAN}ðŸ“‹ Servidores disponÃ­veis:${NC}"
    echo
    
    local count=0
    for server_path in "$MINECRAFT_DIR"/*; do
        if [ -d "$server_path" ] && [[ "$(basename "$server_path")" =~ ^(vanilla|pocketmine|nukkit|forge|bedrock)- ]]; then
            ((count++))
            local server_name=$(basename "$server_path")
            local server_type=${server_name%%-*}
            local display_name=${server_name#*-}
            
            # Verificar se estÃ¡ rodando
            local status="${RED}âšª Parado${NC}"
            if pgrep -f "$server_path" >/dev/null; then
                status="${GREEN}ðŸŸ¢ Rodando${NC}"
            fi
            
            # Determinar porta
            local port="N/A"
            if [ -f "$server_path/server.properties" ]; then
                port=$(grep "server-port=" "$server_path/server.properties" | cut -d'=' -f2)
            fi
            
            # Ler informaÃ§Ãµes do arquivo server_info.txt se existir
            local created_date="N/A"
            if [ -f "$server_path/server_info.txt" ]; then
                created_date=$(grep "CREATED_DATE=" "$server_path/server_info.txt" | cut -d'=' -f2)
            fi
            
            echo -e "${WHITE}$count) ${CYAN}$display_name${NC}"
            echo -e "   ${WHITE}Tipo: ${YELLOW}$(echo $server_type | tr '[:lower:]' '[:upper:]')${NC}"
            echo -e "   ${WHITE}Status: $status"
            echo -e "   ${WHITE}Porta: ${CYAN}$port${NC}"
            echo -e "   ${WHITE}Criado: ${CYAN}$created_date${NC}"
            echo -e "   ${WHITE}Pasta: ${CYAN}$server_path${NC}"
            echo
        fi
    done
    
    if [ $count -eq 0 ]; then
        echo -e "${YELLOW}ðŸ“­ Nenhum servidor encontrado em seu diretÃ³rio${NC}"
    else
        echo -e "${GREEN}âœ… Total: $count servidor(es) encontrado(s)${NC}"
    fi
    
    pause
}

# FunÃ§Ã£o para gerenciar servidores
manage_servers() {
    while true; do
        show_logo
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘        ${WHITE}GERENCIAR SEUS SERVIDORES${BLUE}        â•‘${NC}"
        echo -e "${BLUE}â•‘              ${CYAN}UsuÃ¡rio: $USERNAME${BLUE}             â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        
        # Listar apenas servidores do usuÃ¡rio atual
        local servers=()
        local count=0
        
        for server_path in "$MINECRAFT_DIR"/*; do
            if [ -d "$server_path" ] && [[ "$(basename "$server_path")" =~ ^(vanilla|pocketmine|nukkit|forge|bedrock)- ]]; then
                # Verificar se o servidor pertence ao usuÃ¡rio atual
                local server_owner="unknown"
                if [ -f "$server_path/server_info.txt" ]; then
                    server_owner=$(grep "OWNER=" "$server_path/server_info.txt" | cut -d'=' -f2)
                fi
                
                # SÃ³ mostrar servidores do usuÃ¡rio atual ou sem proprietÃ¡rio definido
                if [ "$server_owner" = "$USERNAME" ] || [ "$server_owner" = "unknown" ]; then
                    ((count++))
                    servers+=("$server_path")
                    local server_name=$(basename "$server_path")
                    local server_type=${server_name%%-*}
                    local display_name=${server_name#*-}
                    
                    # Status do servidor
                    local status="${RED}âšª${NC}"
                    if pgrep -f "$server_path" >/dev/null; then
                        status="${GREEN}ðŸŸ¢${NC}"
                    fi
                    
                    # Mostrar informaÃ§Ãµes bÃ¡sicas
                    local port="N/A"
                    if [ -f "$server_path/server.properties" ]; then
                        port=$(grep "server-port=" "$server_path/server.properties" | cut -d'=' -f2)
                    fi
                    
                    echo -e "${WHITE}$count) $status ${CYAN}$display_name${NC} ${YELLOW}($server_type)${NC} ${WHITE}:$port${NC}"
                fi
            fi
        done
        
        if [ $count -eq 0 ]; then
            echo -e "${YELLOW}ðŸ“­ VocÃª nÃ£o possui servidores ainda${NC}"
            echo -e "${CYAN}ðŸ’¡ Volte ao menu principal para criar seu primeiro servidor!${NC}"
            echo -e "${WHITE}0) ${WHITE}Voltar ao Menu Principal${NC}"
            echo
            echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
            read -r choice
            if [ "$choice" = "0" ]; then
                break
            fi
            continue
        fi
        
        echo
        echo -e "${WHITE}AÃ§Ãµes rÃ¡pidas:${NC}"
        echo -e "${WHITE}$((count+1))) ${GREEN}ðŸš€ Iniciar Servidor${NC}"
        echo -e "${WHITE}$((count+2))) ${YELLOW}ðŸ›‘ Parar Servidor${NC}"
        echo -e "${WHITE}$((count+3))) ${PURPLE}ðŸ“‹ Ver Logs${NC}"
        echo -e "${WHITE}$((count+4))) ${CYAN}ðŸ“‚ Abrir Pasta${NC}"
        echo -e "${WHITE}$((count+5))) ${RED}ðŸ—‘ï¸  Deletar Servidor${NC}"
        echo -e "${WHITE}$((count+6))) ${BLUE}ðŸ“Š EstatÃ­sticas Detalhadas${NC}"
        echo -e "${WHITE}0) ${WHITE}Voltar ao Menu Principal${NC}"
        echo
        echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
        read -r choice
        
        if [ "$choice" = "0" ]; then
            break
        elif [ "$choice" -gt 0 ] && [ "$choice" -le "$count" ]; then
            local selected_server="${servers[$((choice-1))]}"
            server_details_menu "$selected_server"
        elif [ "$choice" = "$((count+1))" ]; then
            start_server_menu "${servers[@]}"
        elif [ "$choice" = "$((count+2))" ]; then
            stop_server_menu "${servers[@]}"
        elif [ "$choice" = "$((count+3))" ]; then
            view_logs_menu "${servers[@]}"
        elif [ "$choice" = "$((count+4))" ]; then
            open_folder_menu "${servers[@]}"
        elif [ "$choice" = "$((count+5))" ]; then
            delete_server_menu "${servers[@]}"
        elif [ "$choice" = "$((count+6))" ]; then
            show_user_statistics
        else
            echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
            sleep 1
        fi
    done
}

# FunÃ§Ã£o para mostrar estatÃ­sticas detalhadas do usuÃ¡rio
show_user_statistics() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘       ${WHITE}ESTATÃSTICAS - ${CYAN}$USERNAME${BLUE}          â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    # Ler configuraÃ§Ãµes do usuÃ¡rio
    local total_servers=$(grep "TOTAL_SERVERS=" "$USER_CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 || echo "0")
    local creation_date=$(grep "CREATION_DATE=" "$USER_CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 || echo "Desconhecido")
    local last_access=$(grep "LAST_ACCESS=" "$USER_CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 || echo "Agora")
    local user_id=$(id -u)
    
    echo -e "${CYAN}ðŸ‘¤ InformaÃ§Ãµes do UsuÃ¡rio:${NC}"
    echo -e "${WHITE}   â€¢ Nome: ${CYAN}$USERNAME${NC}"
    echo -e "${WHITE}   â€¢ User ID: ${CYAN}$user_id${NC}"
    echo -e "${WHITE}   â€¢ Membro desde: ${CYAN}$creation_date${NC}"
    echo -e "${WHITE}   â€¢ Ãšltimo acesso: ${CYAN}$last_access${NC}"
    echo
    
    echo -e "${CYAN}ðŸ“Š EstatÃ­sticas de Servidores:${NC}"
    echo -e "${WHITE}   â€¢ Total criados: ${GREEN}$total_servers${NC}"
    
    # Contar servidores ativos
    local active_servers=0
    local server_types=()
    
    for server_path in "$MINECRAFT_DIR"/*; do
        if [ -d "$server_path" ] && [[ "$(basename "$server_path")" =~ ^(vanilla|pocketmine|nukkit|forge|bedrock)- ]]; then
            local server_owner="unknown"
            if [ -f "$server_path/server_info.txt" ]; then
                server_owner=$(grep "OWNER=" "$server_path/server_info.txt" | cut -d'=' -f2)
            fi
            
            if [ "$server_owner" = "$USERNAME" ] || [ "$server_owner" = "unknown" ]; then
                if pgrep -f "$server_path" >/dev/null; then
                    ((active_servers++))
                fi
                
                # Contar tipos de servidor
                local server_name=$(basename "$server_path")
                local server_type=${server_name%%-*}
                server_types+=("$server_type")
            fi
        fi
    done
    
    echo -e "${WHITE}   â€¢ Servidores rodando: ${GREEN}$active_servers${NC}"
    echo
    
    # Mostrar tipos de servidores
    if [ ${#server_types[@]} -gt 0 ]; then
        echo -e "${CYAN}ðŸŽ® Tipos de Servidores:${NC}"
        echo "${server_types[@]}" | tr ' ' '\n' | sort | uniq -c | while read count type; do
            echo -e "${WHITE}   â€¢ $(echo $type | tr '[:lower:]' '[:upper:]'): ${CYAN}$count${NC}"
        done
        echo
    fi
    
    echo -e "${CYAN}ðŸ“‚ DiretÃ³rios:${NC}"
    echo -e "${WHITE}   â€¢ Pasta pessoal: ${CYAN}$MINECRAFT_DIR${NC}"
    if [ -d "$MINECRAFT_DIR" ]; then
        local dir_size=$(du -sh "$MINECRAFT_DIR" 2>/dev/null | cut -f1)
        echo -e "${WHITE}   â€¢ EspaÃ§o usado: ${CYAN}$dir_size${NC}"
    fi
    
    # Mostrar portas em uso
    echo -e "\n${CYAN}ðŸ”Œ Portas em Uso:${NC}"
    for server_path in "$MINECRAFT_DIR"/*; do
        if [ -d "$server_path" ] && [ -f "$server_path/server.properties" ]; then
            local server_owner="unknown"
            if [ -f "$server_path/server_info.txt" ]; then
                server_owner=$(grep "OWNER=" "$server_path/server_info.txt" | cut -d'=' -f2)
            fi
            
            if [ "$server_owner" = "$USERNAME" ] || [ "$server_owner" = "unknown" ]; then
                local port=$(grep "server-port=" "$server_path/server.properties" | cut -d'=' -f2)
                local server_name=$(basename "$server_path")
                local display_name=${server_name#*-}
                echo -e "${WHITE}   â€¢ $display_name: ${CYAN}$port${NC}"
            fi
        fi
    done
    
    pause
}

# FunÃ§Ã£o para menu de detalhes do servidor
server_details_menu() {
    local server_path="$1"
    local server_name=$(basename "$server_path")
    local server_type=${server_name%%-*}
    local display_name=${server_name#*-}
    
    while true; do
        show_logo
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘       ${WHITE}GERENCIAR: $display_name${BLUE}       â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        
        # Status do servidor
        local status="${RED}âšª Parado${NC}"
        local pid=""
        if pid=$(pgrep -f "$server_path"); then
            status="${GREEN}ðŸŸ¢ Rodando (PID: $pid)${NC}"
        fi
        
        # InformaÃ§Ãµes do servidor
        local port="N/A"
        if [ -f "$server_path/server.properties" ]; then
            port=$(grep "server-port=" "$server_path/server.properties" | cut -d'=' -f2 2>/dev/null || echo "N/A")
        fi
        
        echo -e "${CYAN}ðŸ“Š InformaÃ§Ãµes do Servidor:${NC}"
        echo -e "${WHITE}   â€¢ Nome: ${CYAN}$display_name${NC}"
        echo -e "${WHITE}   â€¢ Tipo: ${YELLOW}$(echo $server_type | tr '[:lower:]' '[:upper:]')${NC}"
        echo -e "${WHITE}   â€¢ Status: $status"
        echo -e "${WHITE}   â€¢ Porta: ${CYAN}$port${NC}"
        echo -e "${WHITE}   â€¢ Pasta: ${CYAN}$server_path${NC}"
        echo
        
        echo -e "${WHITE}1) ${GREEN}Iniciar Servidor${NC}"
        echo -e "${WHITE}2) ${YELLOW}Parar Servidor${NC}"
        echo -e "${WHITE}3) ${PURPLE}Ver Logs em Tempo Real${NC}"
        echo -e "${WHITE}4) ${CYAN}Abrir Pasta do Servidor${NC}"
        echo -e "${WHITE}5) ${BLUE}Editar ConfiguraÃ§Ãµes${NC}"
        echo -e "${WHITE}6) ${RED}Deletar Servidor${NC}"
        echo -e "${WHITE}0) ${WHITE}Voltar${NC}"
        echo
        echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
        read -r choice
        
        case $choice in
            1) start_server "$server_path" ;;
            2) stop_server "$server_path" ;;
            3) view_server_logs "$server_path" ;;
            4) open_server_folder "$server_path" ;;
            5) edit_server_config "$server_path" ;;
            6) 
                delete_server "$server_path"
                if [ $? -eq 0 ]; then
                    break
                fi
                ;;
            0) break ;;
            *) 
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
                sleep 1
                ;;
        esac
    done
}

# FunÃ§Ã£o para iniciar servidor
start_server() {
    local server_path="$1"
    local server_name=$(basename "$server_path")
    
    if pgrep -f "$server_path" >/dev/null; then
        echo -e "${YELLOW}âš ï¸  Servidor jÃ¡ estÃ¡ rodando!${NC}"
        pause
        return
    fi
    
    echo -e "${CYAN}ðŸš€ Iniciando servidor $server_name...${NC}"
    
    if [ -f "$server_path/start.sh" ]; then
        cd "$server_path"
        nohup ./start.sh > server.log 2>&1 &
        local pid=$!
        echo $pid > server.pid
        
        sleep 3
        
        if kill -0 $pid 2>/dev/null; then
            echo -e "${GREEN}âœ… Servidor iniciado com sucesso! (PID: $pid)${NC}"
            echo -e "${CYAN}ðŸ“‹ Para ver os logs: tail -f $server_path/server.log${NC}"
        else
            echo -e "${RED}âŒ Erro ao iniciar servidor${NC}"
            echo -e "${YELLOW}ðŸ“‹ Verificando logs...${NC}"
            tail -10 "$server_path/server.log" 2>/dev/null || echo "Nenhum log encontrado"
        fi
    else
        echo -e "${RED}âŒ Script de inicializaÃ§Ã£o nÃ£o encontrado!${NC}"
    fi
    
    pause
}

# FunÃ§Ã£o para parar servidor
stop_server() {
    local server_path="$1"
    local server_name=$(basename "$server_path")
    
    local pid=$(pgrep -f "$server_path")
    if [ -z "$pid" ]; then
        echo -e "${YELLOW}âš ï¸  Servidor nÃ£o estÃ¡ rodando${NC}"
        pause
        return
    fi
    
    echo -e "${CYAN}ðŸ›‘ Parando servidor $server_name...${NC}"
    
    # Tentar parar graciosamente
    kill $pid
    sleep 5
    
    # Verificar se parou
    if kill -0 $pid 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  ForÃ§ando parada...${NC}"
        kill -9 $pid
        sleep 2
    fi
    
    # Remover arquivo PID se existir
    [ -f "$server_path/server.pid" ] && rm "$server_path/server.pid"
    
    if ! kill -0 $pid 2>/dev/null; then
        echo -e "${GREEN}âœ… Servidor parado com sucesso!${NC}"
    else
        echo -e "${RED}âŒ Erro ao parar servidor${NC}"
    fi
    
    pause
}

# FunÃ§Ã£o para ver logs
view_server_logs() {
    local server_path="$1"
    local server_name=$(basename "$server_path")
    
    if [ ! -f "$server_path/server.log" ]; then
        echo -e "${YELLOW}ðŸ“­ Nenhum log encontrado para $server_name${NC}"
        pause
        return
    fi
    
    echo -e "${CYAN}ðŸ“‹ Logs do servidor $server_name (Ctrl+C para sair):${NC}"
    echo -e "${WHITE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    tail -f "$server_path/server.log"
}

# FunÃ§Ã£o para abrir pasta do servidor
open_server_folder() {
    local server_path="$1"
    local server_name=$(basename "$server_path")
    
    echo -e "${CYAN}ðŸ“‚ Pasta do servidor: $server_path${NC}"
    echo -e "${WHITE}Arquivos no servidor:${NC}"
    ls -la "$server_path"
    pause
}

# FunÃ§Ã£o para editar configuraÃ§Ãµes
edit_server_config() {
    local server_path="$1"
    local server_name=$(basename "$server_path")
    
    if [ ! -f "$server_path/server.properties" ]; then
        echo -e "${YELLOW}ðŸ“‹ Arquivo server.properties nÃ£o encontrado${NC}"
        pause
        return
    fi
    
    echo -e "${CYAN}âš™ï¸  ConfiguraÃ§Ãµes atuais do servidor:${NC}"
    echo -e "${WHITE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    cat "$server_path/server.properties"
    echo -e "${WHITE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    echo -e "${YELLOW}Para editar, use: nano $server_path/server.properties${NC}"
    pause
}

# FunÃ§Ã£o para deletar servidor
delete_server() {
    local server_path="$1"
    local server_name=$(basename "$server_path")
    
    echo -e "${RED}âš ï¸  CUIDADO: Esta aÃ§Ã£o nÃ£o pode ser desfeita!${NC}"
    echo -e "${YELLOW}Servidor a ser deletado: $server_name${NC}"
    echo -e "${WHITE}Pasta: $server_path${NC}"
    echo
    echo -ne "${RED}Digite 'DELETAR' para confirmar: ${NC}"
    read -r confirm
    
    if [ "$confirm" = "DELETAR" ]; then
        # Parar servidor se estiver rodando
        local pid=$(pgrep -f "$server_path")
        if [ -n "$pid" ]; then
            echo -e "${CYAN}ðŸ›‘ Parando servidor antes de deletar...${NC}"
            kill -9 $pid 2>/dev/null
            sleep 2
        fi
        
        echo -e "${CYAN}ðŸ—‘ï¸  Removendo servidor...${NC}"
        rm -rf "$server_path"
        
        if [ ! -d "$server_path" ]; then
            echo -e "${GREEN}âœ… Servidor $server_name deletado com sucesso!${NC}"
            pause
            return 0
        else
            echo -e "${RED}âŒ Erro ao deletar servidor${NC}"
            pause
            return 1
        fi
    else
        echo -e "${YELLOW}âŒ OperaÃ§Ã£o cancelada${NC}"
        pause
        return 1
    fi
}

# Menus auxiliares para aÃ§Ãµes em massa
start_server_menu() {
    local servers=("$@")
    echo -e "${CYAN}ðŸš€ Escolha um servidor para iniciar:${NC}"
    
    local count=0
    for server_path in "${servers[@]}"; do
        ((count++))
        local server_name=$(basename "$server_path")
        local display_name=${server_name#*-}
        
        if pgrep -f "$server_path" >/dev/null; then
            echo -e "${WHITE}$count) ${CYAN}$display_name${NC} ${GREEN}(jÃ¡ rodando)${NC}"
        else
            echo -e "${WHITE}$count) ${CYAN}$display_name${NC} ${RED}(parado)${NC}"
        fi
    done
    
    echo -ne "${YELLOW}NÃºmero do servidor: ${NC}"
    read -r choice
    
    if [ "$choice" -gt 0 ] && [ "$choice" -le "${#servers[@]}" ]; then
        start_server "${servers[$((choice-1))]}"
    fi
}

stop_server_menu() {
    local servers=("$@")
    echo -e "${YELLOW}ðŸ›‘ Escolha um servidor para parar:${NC}"
    
    local count=0
    for server_path in "${servers[@]}"; do
        ((count++))
        local server_name=$(basename "$server_path")
        local display_name=${server_name#*-}
        
        if pgrep -f "$server_path" >/dev/null; then
            echo -e "${WHITE}$count) ${CYAN}$display_name${NC} ${GREEN}(rodando)${NC}"
        else
            echo -e "${WHITE}$count) ${CYAN}$display_name${NC} ${RED}(jÃ¡ parado)${NC}"
        fi
    done
    
    echo -ne "${YELLOW}NÃºmero do servidor: ${NC}"
    read -r choice
    
    if [ "$choice" -gt 0 ] && [ "$choice" -le "${#servers[@]}" ]; then
        stop_server "${servers[$((choice-1))]}"
    fi
}

view_logs_menu() {
    local servers=("$@")
    echo -e "${PURPLE}ðŸ“‹ Escolha um servidor para ver os logs:${NC}"
    
    local count=0
    for server_path in "${servers[@]}"; do
        ((count++))
        local server_name=$(basename "$server_path")
        local display_name=${server_name#*-}
        echo -e "${WHITE}$count) ${CYAN}$display_name${NC}"
    done
    
    echo -ne "${YELLOW}NÃºmero do servidor: ${NC}"
    read -r choice
    
    if [ "$choice" -gt 0 ] && [ "$choice" -le "${#servers[@]}" ]; then
        view_server_logs "${servers[$((choice-1))]}"
    fi
}

open_folder_menu() {
    local servers=("$@")
    echo -e "${CYAN}ðŸ“‚ Escolha um servidor para abrir a pasta:${NC}"
    
    local count=0
    for server_path in "${servers[@]}"; do
        ((count++))
        local server_name=$(basename "$server_path")
        local display_name=${server_name#*-}
        echo -e "${WHITE}$count) ${CYAN}$display_name${NC}"
    done
    
    echo -ne "${YELLOW}NÃºmero do servidor: ${NC}"
    read -r choice
    
    if [ "$choice" -gt 0 ] && [ "$choice" -le "${#servers[@]}" ]; then
        open_server_folder "${servers[$((choice-1))]}"
    fi
}

delete_server_menu() {
    local servers=("$@")
    echo -e "${RED}ðŸ—‘ï¸  Escolha um servidor para DELETAR:${NC}"
    
    local count=0
    for server_path in "${servers[@]}"; do
        ((count++))
        local server_name=$(basename "$server_path")
        local display_name=${server_name#*-}
        echo -e "${WHITE}$count) ${CYAN}$display_name${NC}"
    done
    
    echo -ne "${YELLOW}NÃºmero do servidor: ${NC}"
    read -r choice
    
    if [ "$choice" -gt 0 ] && [ "$choice" -le "${#servers[@]}" ]; then
        delete_server "${servers[$((choice-1))]}"
    fi
}

# Menu principal
main_menu() {
    while true; do
        show_logo
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘            ${WHITE}MENU PRINCIPAL${BLUE}               â•‘${NC}"
        echo -e "${BLUE}â•‘              ${CYAN}UsuÃ¡rio: $USERNAME${BLUE}             â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        
        # Mostrar estatÃ­sticas rÃ¡pidas
        local total_servers=$(grep "TOTAL_SERVERS=" "$USER_CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 || echo "0")
        local active_servers=0
        for server_path in "$MINECRAFT_DIR"/*; do
            if [ -d "$server_path" ] && [[ "$(basename "$server_path")" =~ ^(vanilla|pocketmine|nukkit|forge|bedrock)- ]]; then
                if pgrep -f "$server_path" >/dev/null; then
                    ((active_servers++))
                fi
            fi
        done
        
        echo -e "${CYAN}ðŸ“Š Seus servidores: ${GREEN}$total_servers criados${NC} | ${YELLOW}$active_servers rodando${NC}"
        echo
        
        echo -e "${WHITE}ðŸ“¦ CRIAR NOVOS SERVIDORES:${NC}"
        echo -e "${WHITE}1)${NC} ${GREEN}ðŸŽ® Servidor Vanilla/Paper${NC}"
        echo -e "${WHITE}2)${NC} ${CYAN}ðŸ“± Servidor PocketMine-MP (Bedrock)${NC}"
        echo -e "${WHITE}3)${NC} ${YELLOW}âš¡ Servidor Nukkit (Bedrock)${NC}"
        echo -e "${WHITE}4)${NC} ${PURPLE}ðŸ”§ Servidor Forge (Mods Java)${NC}"
        echo -e "${WHITE}5)${NC} ${BLUE}ðŸ¢ Servidor Bedrock Oficial${NC}"
        echo
        echo -e "${WHITE}âš™ï¸  GERENCIAR SEUS SERVIDORES:${NC}"
        echo -e "${WHITE}6)${NC} ${WHITE}ðŸ“‹ Listar Seus Servidores${NC}"
        echo -e "${WHITE}7)${NC} ${WHITE}ðŸŽ›ï¸  Gerenciar Servidores${NC}"
        echo -e "${WHITE}8)${NC} ${CYAN}ðŸ“Š EstatÃ­sticas Pessoais${NC}"
        echo -e "${WHITE}9)${NC} ${GREEN}ðŸŒ Gerenciar TÃºneis SSH${NC}"
        echo
        echo -e "${WHITE}â„¹ï¸  INFORMAÃ‡Ã•ES:${NC}"
        echo -e "${WHITE}10)${NC} ${BLUE}ðŸ’¡ Como Conectar aos Servidores${NC}"
        echo
        echo -e "${WHITE}0)${NC} ${RED}ðŸšª Sair${NC}"
        echo
        echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
        read -r choice
        
        case $choice in
            1) create_vanilla_server ;;
            2) create_pocketmine_server ;;
            3) create_nukkit_server ;;
            4) create_forge_server ;;
            5) create_bedrock_server ;;
            6) list_servers ;;
            7) manage_servers ;;
            8) show_user_statistics ;;
            9) manage_ssh_tunnels ;;
            10) show_connection_help ;;
            0) 
                echo -e "\n${GREEN}ðŸ‘‹ Obrigado por usar o Minecraft Server Installer, $USERNAME!${NC}"
                echo -e "${CYAN}   Todos os seus servidores estÃ£o em: $MINECRAFT_DIR${NC}"
                echo -e "${YELLOW}   ðŸ’¡ Dica: Use tÃºneis SSH para acesso seguro pela internet!${NC}"
                exit 0
                ;;
            *) 
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida! Tente novamente.${NC}"
                sleep 1
                ;;
        esac
    done
}

# FunÃ§Ã£o para mostrar ajuda de conexÃ£o
show_connection_help() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘        ${WHITE}COMO CONECTAR AOS SERVIDORES${BLUE}     â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -e "${CYAN}ðŸŒ Como conectar aos seus servidores:${NC}"
    echo
    
    echo -e "${WHITE}1ï¸âƒ£  Servidores Java (Vanilla, Forge):${NC}"
    echo -e "${YELLOW}   â€¢ Abra o Minecraft Java Edition${NC}"
    echo -e "${YELLOW}   â€¢ VÃ¡ em Multiplayer â†’ Add Server${NC}"
    echo -e "${YELLOW}   â€¢ Server Address: ${CYAN}SEU_IP:PORTA${NC}"
    echo -e "${YELLOW}   â€¢ Exemplo: ${CYAN}192.168.1.100:25565${NC}"
    echo
    
    echo -e "${WHITE}2ï¸âƒ£  Servidores Bedrock (PocketMine, Nukkit, Bedrock):${NC}"
    echo -e "${YELLOW}   â€¢ Abra o Minecraft Bedrock Edition${NC}"
    echo -e "${YELLOW}   â€¢ VÃ¡ em Play â†’ Servers â†’ Add Server${NC}"
    echo -e "${YELLOW}   â€¢ Server Address: ${CYAN}SEU_IP${NC}"
    echo -e "${YELLOW}   â€¢ Port: ${CYAN}PORTA${NC} (geralmente 19132)${NC}"
    echo
    
    echo -e "${WHITE}ðŸ” Para descobrir seu IP:${NC}"
    echo -e "${YELLOW}   â€¢ IP local: ${CYAN}$(hostname -I | awk '{print $1}')${NC}"
    echo -e "${YELLOW}   â€¢ IP pÃºblico: ${CYAN}$(curl -s ifconfig.me 2>/dev/null || echo "Execute: curl ifconfig.me")${NC}"
    echo
    
    echo -e "${WHITE}ðŸ“‹ Suas portas em uso:${NC}"
    local found_servers=false
    for server_path in "$MINECRAFT_DIR"/*; do
        if [ -d "$server_path" ] && [ -f "$server_path/server.properties" ]; then
            local server_owner="unknown"
            if [ -f "$server_path/server_info.txt" ]; then
                server_owner=$(grep "OWNER=" "$server_path/server_info.txt" | cut -d'=' -f2)
            fi
            
            if [ "$server_owner" = "$USERNAME" ] || [ "$server_owner" = "unknown" ]; then
                found_servers=true
                local port=$(grep "server-port=" "$server_path/server.properties" | cut -d'=' -f2)
                local server_name=$(basename "$server_path")
                local server_type=${server_name%%-*}
                local display_name=${server_name#*-}
                
                local status="${RED}âšª${NC}"
                if pgrep -f "$server_path" >/dev/null; then
                    status="${GREEN}ðŸŸ¢${NC}"
                fi
                
                echo -e "${WHITE}   â€¢ $display_name ($(echo $server_type | tr '[:lower:]' '[:upper:]')): ${CYAN}$port${NC} $status"
                
                # Mostrar endereÃ§os de conexÃ£o especÃ­ficos
                echo -e "${WHITE}     - Local: ${CYAN}$LOCAL_IP:$port${NC}"
                if [ -n "$PUBLIC_IP" ]; then
                    echo -e "${WHITE}     - PÃºblico: ${CYAN}$PUBLIC_IP:$port${NC} ${YELLOW}(requer port forwarding)${NC}"
                fi
                
                # Verificar se hÃ¡ tÃºneis configurados para este servidor
                if [ -f "$SSH_TUNNELS_FILE" ]; then
                    while IFS='|' read -r tunnel_name tunnel_local_port tunnel_host tunnel_user tunnel_remote_port tunnel_ssh_port tunnel_type; do
                        if [ "$tunnel_local_port" = "$port" ]; then
                            echo -e "${WHITE}     - TÃºnel SSH: ${CYAN}$tunnel_host:$tunnel_remote_port${NC}"
                        fi
                    done < "$SSH_TUNNELS_FILE"
                fi
                echo
            fi
        fi
    done
    
    if [ "$found_servers" = false ]; then
        echo -e "${YELLOW}   Nenhum servidor encontrado. Crie um primeiro!${NC}"
    fi
    
    echo -e "${WHITE}ðŸ”§ ServiÃ§os de Tunneling DisponÃ­veis:${NC}"
    if command -v ngrok &> /dev/null || [ -f "$MINECRAFT_DIR/tools/ngrok" ]; then
        echo -e "${GREEN}   âœ… ngrok instalado${NC}"
    else
        echo -e "${YELLOW}   âš ï¸  ngrok nÃ£o instalado${NC}"
    fi
    
    if command -v cloudflared &> /dev/null; then
        echo -e "${GREEN}   âœ… cloudflared instalado${NC}"
    else
        echo -e "${YELLOW}   âš ï¸  cloudflared nÃ£o instalado${NC}"
    fi
    
    if command -v lt &> /dev/null; then
        echo -e "${GREEN}   âœ… localtunnel instalado${NC}"
    else
        echo -e "${YELLOW}   âš ï¸  localtunnel nÃ£o instalado${NC}"
    fi
    
    echo
    echo -e "${WHITE}âš ï¸  Importante:${NC}"
    echo -e "${YELLOW}   â€¢ Certifique-se que o servidor estÃ¡ rodando antes de conectar${NC}"
    echo -e "${YELLOW}   â€¢ Configure o firewall se necessÃ¡rio${NC}"
    echo -e "${YELLOW}   â€¢ Para acesso externo, configure port forwarding no roteador${NC}"
    echo -e "${YELLOW}   â€¢ TÃºneis SSH sÃ£o mais seguros que port forwarding${NC}"
    
    pause
}

# FunÃ§Ã£o para gerenciar tÃºneis SSH
manage_ssh_tunnels() {
    while true; do
        show_logo
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘         ${WHITE}GERENCIAR TÃšNEIS SSH${BLUE}          â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        
        if [ ! -f "$SSH_TUNNELS_FILE" ] || [ ! -s "$SSH_TUNNELS_FILE" ]; then
            echo -e "${YELLOW}ðŸ“­ Nenhum tÃºnel SSH configurado${NC}"
            echo -e "${CYAN}ðŸ’¡ Configure tÃºneis ao criar novos servidores!${NC}"
            echo -e "${WHITE}0) ${WHITE}Voltar ao Menu Principal${NC}"
            echo
            echo -ne "${YELLOW}Pressione ENTER para voltar: ${NC}"
            read -r
            break
        fi
        
        echo -e "${CYAN}ðŸŒ TÃºneis SSH configurados:${NC}"
        echo
        
        local count=0
        while IFS='|' read -r name local_port remote_host remote_user remote_port ssh_port server_type; do
            ((count++))
            
            # Verificar se o tÃºnel estÃ¡ ativo
            local tunnel_status="${RED}âšª Inativo${NC}"
            if pgrep -f "ssh.*$remote_port:localhost:$local_port" >/dev/null; then
                tunnel_status="${GREEN}ðŸŸ¢ Ativo${NC}"
            fi
            
            echo -e "${WHITE}$count) ${CYAN}$name${NC} ($(echo $server_type | tr '[:lower:]' '[:upper:]'))"
            echo -e "   ${WHITE}Status: $tunnel_status"
            echo -e "   ${WHITE}Local: ${CYAN}localhost:$local_port${NC} â†’ Remoto: ${CYAN}$remote_host:$remote_port${NC}"
            echo -e "   ${WHITE}SSH: ${CYAN}$remote_user@$remote_host:$ssh_port${NC}"
            echo
        done < "$SSH_TUNNELS_FILE"
        
        echo -e "${WHITE}AÃ§Ãµes:${NC}"
        echo -e "${WHITE}$((count+1))) ${GREEN}ðŸš€ Iniciar TÃºnel${NC}"
        echo -e "${WHITE}$((count+2))) ${YELLOW}ðŸ›‘ Parar TÃºnel${NC}"
        echo -e "${WHITE}$((count+3))) ${PURPLE}ðŸ“‹ Ver Status Detalhado${NC}"
        echo -e "${WHITE}$((count+4))) ${RED}ðŸ—‘ï¸  Remover TÃºnel${NC}"
        echo -e "${WHITE}$((count+5))) ${BLUE}âž• Adicionar Novo TÃºnel${NC}"
        echo -e "${WHITE}0) ${WHITE}Voltar ao Menu Principal${NC}"
        echo
        echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
        read -r choice
        
        if [ "$choice" = "0" ]; then
            break
        elif [ "$choice" -gt 0 ] && [ "$choice" -le "$count" ]; then
            manage_specific_tunnel "$choice"
        elif [ "$choice" = "$((count+1))" ]; then
            start_tunnel_menu
        elif [ "$choice" = "$((count+2))" ]; then
            stop_tunnel_menu
        elif [ "$choice" = "$((count+3))" ]; then
            show_tunnels_status
        elif [ "$choice" = "$((count+4))" ]; then
            remove_tunnel_menu
        elif [ "$choice" = "$((count+5))" ]; then
            add_new_tunnel_menu
        else
            echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
            sleep 1
        fi
    done
}

# FunÃ§Ã£o para iniciar tÃºnel especÃ­fico
start_tunnel_menu() {
    echo -e "${CYAN}ðŸš€ Escolha um tÃºnel para iniciar:${NC}"
    echo
    
    local count=0
    while IFS='|' read -r name local_port remote_host remote_user remote_port ssh_port server_type; do
        ((count++))
        
        local tunnel_status="${RED}âšª${NC}"
        if pgrep -f "ssh.*$remote_port:localhost:$local_port" >/dev/null; then
            tunnel_status="${GREEN}ðŸŸ¢${NC}"
        fi
        
        echo -e "${WHITE}$count) $tunnel_status ${CYAN}$name${NC} â†’ $remote_host:$remote_port"
    done < "$SSH_TUNNELS_FILE"
    
    echo -ne "${YELLOW}NÃºmero do tÃºnel: ${NC}"
    read -r tunnel_choice
    
    if [ "$tunnel_choice" -gt 0 ] && [ "$tunnel_choice" -le "$count" ]; then
        local selected_line=$(sed -n "${tunnel_choice}p" "$SSH_TUNNELS_FILE")
        IFS='|' read -r name local_port remote_host remote_user remote_port ssh_port server_type <<< "$selected_line"
        
        # Verificar se jÃ¡ estÃ¡ rodando
        if pgrep -f "ssh.*$remote_port:localhost:$local_port" >/dev/null; then
            echo -e "${YELLOW}âš ï¸  TÃºnel jÃ¡ estÃ¡ ativo!${NC}"
        else
            echo -e "${CYAN}ðŸš€ Iniciando tÃºnel $name...${NC}"
            
            # Verificar se o servidor local estÃ¡ rodando
            local server_running=false
            for server_path in "$MINECRAFT_DIR"/*; do
                if [ -d "$server_path" ] && [ -f "$server_path/server.properties" ]; then
                    local port=$(grep "server-port=" "$server_path/server.properties" | cut -d'=' -f2)
                    if [ "$port" = "$local_port" ] && pgrep -f "$server_path" >/dev/null; then
                        server_running=true
                        break
                    fi
                fi
            done
            
            if [ "$server_running" = false ]; then
                echo -e "${YELLOW}âš ï¸  Servidor local na porta $local_port nÃ£o estÃ¡ rodando${NC}"
                echo -e "${WHITE}Deseja continuar mesmo assim? (y/N): ${NC}"
                read -r continue_anyway
                if [[ ! $continue_anyway =~ ^[Yy]$ ]]; then
                    return
                fi
            fi
            
            # Executar o script de tÃºnel se existir
            local tunnel_script="$MINECRAFT_DIR/tunnel-$name.sh"
            if [ -f "$tunnel_script" ]; then
                echo -e "${GREEN}Executando script de tÃºnel...${NC}"
                echo -e "${YELLOW}Pressione Ctrl+C para parar o tÃºnel${NC}"
                "$tunnel_script"
            else
                # Executar comando SSH diretamente
                local tunnel_cmd="ssh -R $remote_port:localhost:$local_port -N -p $ssh_port $remote_user@$remote_host"
                echo -e "${GREEN}Executando: $tunnel_cmd${NC}"
                echo -e "${YELLOW}Pressione Ctrl+C para parar o tÃºnel${NC}"
                $tunnel_cmd
            fi
        fi
    fi
    
    pause
}

# FunÃ§Ã£o para parar tÃºnel
stop_tunnel_menu() {
    echo -e "${YELLOW}ðŸ›‘ Parando todos os tÃºneis SSH ativos...${NC}"
    
    local stopped=0
    while IFS='|' read -r name local_port remote_host remote_user remote_port ssh_port server_type; do
        local pid=$(pgrep -f "ssh.*$remote_port:localhost:$local_port")
        if [ -n "$pid" ]; then
            kill "$pid" 2>/dev/null
            echo -e "${GREEN}âœ… TÃºnel $name parado (PID: $pid)${NC}"
            ((stopped++))
        fi
    done < "$SSH_TUNNELS_FILE"
    
    if [ "$stopped" -eq 0 ]; then
        echo -e "${YELLOW}â„¹ï¸  Nenhum tÃºnel ativo encontrado${NC}"
    else
        echo -e "${GREEN}âœ… $stopped tÃºnel(s) parado(s)${NC}"
    fi
    
    pause
}

# FunÃ§Ã£o para mostrar status detalhado dos tÃºneis
show_tunnels_status() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘        ${WHITE}STATUS DETALHADO TÃšNEIS${BLUE}        â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    while IFS='|' read -r name local_port remote_host remote_user remote_port ssh_port server_type; do
        echo -e "${CYAN}ðŸ”— TÃºnel: $name${NC}"
        echo -e "${WHITE}   Tipo: $(echo $server_type | tr '[:lower:]' '[:upper:]')${NC}"
        echo -e "${WHITE}   Local: localhost:$local_port${NC}"
        echo -e "${WHITE}   Remoto: $remote_host:$remote_port${NC}"
        echo -e "${WHITE}   SSH: $remote_user@$remote_host:$ssh_port${NC}"
        
        # Status do tÃºnel
        local pid=$(pgrep -f "ssh.*$remote_port:localhost:$local_port")
        if [ -n "$pid" ]; then
            echo -e "${WHITE}   Status: ${GREEN}ðŸŸ¢ Ativo (PID: $pid)${NC}"
        else
            echo -e "${WHITE}   Status: ${RED}âšª Inativo${NC}"
        fi
        
        # Status do servidor local
        local server_status="${RED}âšª Parado${NC}"
        for server_path in "$MINECRAFT_DIR"/*; do
            if [ -d "$server_path" ] && [ -f "$server_path/server.properties" ]; then
                local port=$(grep "server-port=" "$server_path/server.properties" | cut -d'=' -f2)
                if [ "$port" = "$local_port" ] && pgrep -f "$server_path" >/dev/null; then
                    server_status="${GREEN}ðŸŸ¢ Rodando${NC}"
                    break
                fi
            fi
        done
        echo -e "${WHITE}   Servidor: $server_status"
        
        # Testar conectividade SSH
        echo -e "${CYAN}   Testando SSH...${NC}"
        if timeout 5 ssh -o BatchMode=yes -o ConnectTimeout=5 -p "$ssh_port" "$remote_user@$remote_host" exit 2>/dev/null; then
            echo -e "${WHITE}   SSH: ${GREEN}âœ… ConectÃ¡vel${NC}"
        else
            echo -e "${WHITE}   SSH: ${RED}âŒ Erro de conexÃ£o${NC}"
        fi
        
        echo
    done < "$SSH_TUNNELS_FILE"
    
    pause
}

# FunÃ§Ã£o principal
main() {
    # Verificar dependÃªncias
    check_dependencies
    
    # Mostrar menu principal
    main_menu
}

# Executar script
main "$@"
