#!/bin/bash
set -e

# Cores para interface
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Definir diretÃ³rio de trabalho
PTERODACTYL_DIR="./pterodactyl"

# FunÃ§Ã£o para exibir o logo
show_logo() {
    clear
    echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${PURPLE}â•‘                                                                              â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${WHITE}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— ${CYAN}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— ${PURPLE} â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${WHITE}â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•${CYAN}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—${PURPLE} â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${WHITE}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘          â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  ${CYAN}â–ˆâ–ˆâ•‘  â•šâ•â•${PURPLE} â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${WHITE}â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘          â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  ${CYAN}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—${PURPLE} â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${WHITE}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—${CYAN}â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•${PURPLE} â•‘${NC}"
    echo -e "${PURPLE}â•‘  ${WHITE}â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â• â•šâ•â•â•â•â•â•      â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•${CYAN} â•šâ•â•â•â•â• ${PURPLE} â•‘${NC}"
    echo -e "${PURPLE}â•‘                                                                              â•‘${NC}"
    echo -e "${PURPLE}â•‘                      ${YELLOW}Pterodactyl One-Click Installer${PURPLE}                     â•‘${NC}"
    echo -e "${PURPLE}â•‘                            ${CYAN}VersÃ£o 1.0 - by Eric${PURPLE}                           â•‘${NC}"
    echo -e "${PURPLE}â•‘                                                                              â•‘${NC}"
    echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

# FunÃ§Ã£o para pausar
pause() {
    echo -e "\n${YELLOW}Pressione ENTER para continuar...${NC}"
    read -r
}

# FunÃ§Ã£o para verificar dependÃªncias e permissÃµes
check_requirements() {
    # Verificar Docker
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}âŒ Docker nÃ£o estÃ¡ instalado!${NC}"
        echo -e "${YELLOW}Por favor, instale o Docker primeiro.${NC}"
        echo -e "${CYAN}Visite: https://docs.docker.com/get-docker/${NC}"
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        echo -e "${RED}âŒ Docker Compose nÃ£o estÃ¡ disponÃ­vel!${NC}"
        echo -e "${YELLOW}Por favor, instale o Docker Compose primeiro.${NC}"
        exit 1
    fi
    
    # Usar caminho absoluto para evitar problemas
    PTERODACTYL_DIR="$(pwd)/pterodactyl"
    
    # Verificar/criar diretÃ³rio principal
    echo -e "${CYAN}ğŸ“ Criando diretÃ³rio principal: $PTERODACTYL_DIR${NC}"
    
    if ! mkdir -p "$PTERODACTYL_DIR" 2>/dev/null; then
        echo -e "${RED}âŒ Erro ao criar diretÃ³rio!${NC}"
        echo -e "${YELLOW}Tentando com sudo...${NC}"
        sudo mkdir -p "$PTERODACTYL_DIR"
        sudo chown -R $USER:$USER "$PTERODACTYL_DIR"
    fi
    
    # Verificar permissÃµes de escrita
    if [ ! -w "$PTERODACTYL_DIR" ]; then
        echo -e "${YELLOW}âš ï¸  Ajustando permissÃµes do diretÃ³rio...${NC}"
        sudo chown -R $USER:$USER "$PTERODACTYL_DIR" 2>/dev/null || {
            echo -e "${RED}âŒ Sem permissÃ£o de escrita em: $PTERODACTYL_DIR${NC}"
            PTERODACTYL_DIR="/tmp/pterodactyl"
            mkdir -p "$PTERODACTYL_DIR"
            echo -e "${YELLOW}Usando diretÃ³rio temporÃ¡rio: $PTERODACTYL_DIR${NC}"
        }
    fi
    
    echo -e "${GREEN}âœ… DiretÃ³rio de instalaÃ§Ã£o: $PTERODACTYL_DIR${NC}"
}

# FunÃ§Ã£o para corrigir permissÃµes do Wings
fix_wings_permissions() {
    echo -e "${CYAN}ğŸ”§ Preparando ambiente para o Wings...${NC}"
    
    # Criar diretÃ³rio temporÃ¡rio se nÃ£o existir
    sudo mkdir -p /tmp/pterodactyl
    sudo chown -R $USER:$USER /tmp/pterodactyl
    sudo chmod 777 /tmp/pterodactyl
    
    echo -e "${GREEN}âœ… Ambiente preparado para o Wings!${NC}"
}

# FunÃ§Ã£o para criar usuÃ¡rio administrativo
create_admin_user() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘       ${WHITE}CRIAR USUÃRIO ADMINISTRATIVO${BLUE}     â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    if [ ! -d "$PTERODACTYL_DIR/panel" ]; then
        echo -e "${RED}âŒ Panel nÃ£o estÃ¡ instalado!${NC}"
        echo -e "${YELLOW}Instale o Panel primeiro antes de criar usuÃ¡rios.${NC}"
        pause
        return 1
    fi
    
    if [ ! -f "$PTERODACTYL_DIR/panel/docker-compose.yml" ]; then
        echo -e "${RED}âŒ ConfiguraÃ§Ã£o do Panel nÃ£o encontrada!${NC}"
        echo -e "${YELLOW}Reinstale o Panel ou verifique a instalaÃ§Ã£o.${NC}"
        pause
        return 1
    fi
    
    # Verificar se o panel estÃ¡ rodando
    cd "$PTERODACTYL_DIR/panel"
    if ! docker compose ps -q >/dev/null 2>&1 && ! docker-compose ps -q >/dev/null 2>&1; then
        echo -e "${RED}âŒ Panel nÃ£o estÃ¡ rodando!${NC}"
        echo -e "${YELLOW}Iniciando Panel...${NC}"
        docker compose up -d 2>/dev/null || docker-compose up -d 2>/dev/null
        sleep 10
    fi
    cd - >/dev/null
    
    echo -e "${CYAN}ğŸ‘¤ Vamos criar seu usuÃ¡rio administrativo...${NC}"
    echo
    
    # Coletar informaÃ§Ãµes do usuÃ¡rio
    echo -ne "${YELLOW}Nome de usuÃ¡rio: ${NC}"
    read -r username
    
    echo -ne "${YELLOW}Email: ${NC}"
    read -r email
    
    echo -ne "${YELLOW}Nome completo: ${NC}"
    read -r fullname
    
    echo -ne "${YELLOW}Senha: ${NC}"
    read -rs password
    echo
    
    echo -ne "${YELLOW}Confirme a senha: ${NC}"
    read -rs password_confirm
    echo
    
    if [ "$password" != "$password_confirm" ]; then
        echo -e "${RED}âŒ Senhas nÃ£o coincidem!${NC}"
        pause
        return 1
    fi
    
    echo -e "${CYAN}ğŸ”„ Criando usuÃ¡rio administrativo...${NC}"
    
    # Executar comando no container
    cd "$PTERODACTYL_DIR/panel"
    CONTAINER_NAME=$(docker compose ps -q panel 2>/dev/null || docker-compose ps -q panel 2>/dev/null)
    
    if [ -z "$CONTAINER_NAME" ]; then
        echo -e "${RED}âŒ Container do Panel nÃ£o encontrado!${NC}"
        cd - >/dev/null
        pause
        return 1
    fi
    
    # Criar usuÃ¡rio usando artisan
    docker exec -it "$CONTAINER_NAME" php artisan p:user:make \
        --email="$email" \
        --username="$username" \
        --name-first="$(echo $fullname | cut -d' ' -f1)" \
        --name-last="$(echo $fullname | cut -d' ' -f2-)" \
        --password="$password" \
        --admin=1
    
    cd - >/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "\n${GREEN}âœ… UsuÃ¡rio administrativo criado com sucesso!${NC}"
        echo -e "${YELLOW}ğŸ“‹ InformaÃ§Ãµes do usuÃ¡rio:${NC}"
        echo -e "${WHITE}   â€¢ Nome de usuÃ¡rio: ${CYAN}$username${NC}"
        echo -e "${WHITE}   â€¢ Email: ${CYAN}$email${NC}"
        echo -e "${WHITE}   â€¢ Nome: ${CYAN}$fullname${NC}"
        echo -e "${WHITE}   â€¢ Tipo: ${CYAN}Administrador${NC}"
        echo
        echo -e "${GREEN}ğŸŒ Acesse: ${CYAN}http://localhost:8080${NC}"
    else
        echo -e "${RED}âŒ Erro ao criar usuÃ¡rio!${NC}"
        echo -e "${YELLOW}âš ï¸  Verifique se o Panel estÃ¡ funcionando corretamente.${NC}"
    fi
    
    pause
}

# FunÃ§Ã£o para instalar Pterodactyl Panel
install_panel() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘        ${WHITE}INSTALANDO PTERODACTYL PANEL${BLUE}    â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -e "${CYAN}ğŸ“ Criando estrutura de pastas...${NC}"
    mkdir -p "$PTERODACTYL_DIR/panel"/{var,nginx,database}
    
    # Verificar se as pastas foram crÃ©adas
    if [ ! -d "$PTERODACTYL_DIR/panel" ]; then
        echo -e "${RED}âŒ Falha ao criar estrutura de pastas!${NC}"
        return 1
    fi
    
    echo -e "${CYAN}ğŸ“ Criando configuraÃ§Ã£o do Docker Compose...${NC}"
    
    # Criar docker-compose para o Painel
    cat > "$PTERODACTYL_DIR/panel/docker-compose.yml" << 'EOF'
version: '3.8'

services:
  panel:
    image: ghcr.io/pterodactyl/panel:latest
    restart: always
    ports:
      - "8080:80"
    environment:
      - APP_URL=http://localhost:8080
      - APP_TIMEZONE=UTC
      - DB_HOST=database
      - DB_PORT=3306
      - DB_DATABASE=panel
      - DB_USERNAME=pterodactyl
      - DB_PASSWORD=CHANGE_ME_SECURE_PASSWORD
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_DRIVER=redis
      - REDIS_HOST=cache
    volumes:
      - ./var/:/app/var
      - ./nginx/:/etc/nginx/conf.d
    depends_on:
      - database
      - cache

  database:
    image: mariadb:10.11
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=CHANGE_ROOT_PASSWORD_SECURE
      - MYSQL_DATABASE=panel
      - MYSQL_USER=pterodactyl
      - MYSQL_PASSWORD=CHANGE_ME_SECURE_PASSWORD
    volumes:
      - ./database:/var/lib/mysql
    ports:
      - "3306:3306"

  cache:
    image: redis:alpine
    restart: always
    ports:
      - "6379:6379"
EOF

    echo -e "${CYAN}ğŸš€ Iniciando containers...${NC}"
    cd "$PTERODACTYL_DIR/panel"
    
    # Usar docker compose (comando mais novo) ou docker-compose (comando legado)
    if docker compose version &> /dev/null; then
        docker compose up -d
    else
        docker-compose up -d
    fi
    
    cd - >/dev/null
    
    echo -e "\n${GREEN}âœ… Pterodactyl Panel instalado com sucesso!${NC}"
    echo -e "${YELLOW}ğŸ“‹ InformaÃ§Ãµes importantes:${NC}"
    echo -e "${WHITE}   â€¢ URL do Painel: ${CYAN}http://localhost:8080${NC}"
    echo -e "${WHITE}   â€¢ Banco de dados: MariaDB na porta 3306${NC}"
    echo -e "${WHITE}   â€¢ Cache: Redis na porta 6379${NC}"
    echo -e "${WHITE}   â€¢ Arquivos: $PTERODACTYL_DIR/panel/${NC}"
    echo
    echo -e "${RED}ğŸ” IMPORTANTE: Altere as senhas no docker-compose.yml antes de usar em produÃ§Ã£o!${NC}"
    echo -e "${BLUE}ğŸ’¡ PRÃ“XIMO PASSO: Crie um usuÃ¡rio administrativo no menu de gerenciamento!${NC}"
    
    pause
}

# FunÃ§Ã£o para instalar Wings
install_wings() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘         ${WHITE}INSTALANDO PTERODACTYL WINGS${BLUE}    â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -e "${CYAN}ğŸ”§ Debug - Instalando em: $PTERODACTYL_DIR/wings${NC}"
    
    # Corrigir permissÃµes primeiro
    fix_wings_permissions
    
    echo -e "${CYAN}ğŸ“ Criando estrutura de pastas...${NC}"
    
    # Criar diretÃ³rio principal se nÃ£o existir
    if ! mkdir -p "$PTERODACTYL_DIR/wings" 2>/dev/null; then
        echo -e "${RED}âŒ Erro ao criar diretÃ³rio principal!${NC}"
        echo -e "${YELLOW}Tentando com sudo...${NC}"
        sudo mkdir -p "$PTERODACTYL_DIR/wings"
        sudo chown -R $USER:$USER "$PTERODACTYL_DIR/wings"
    fi
    
    # Criar subdiretÃ³rios
    mkdir -p "$PTERODACTYL_DIR/wings/data"
    mkdir -p "$PTERODACTYL_DIR/wings/volumes"
    
    # Verificar se as pastas foram criadas
    if [ ! -d "$PTERODACTYL_DIR/wings" ]; then
        echo -e "${RED}âŒ Falha ao criar estrutura de pastas!${NC}"
        echo -e "${YELLOW}ğŸ“‚ Tentando listar diretÃ³rio pai:${NC}"
        ls -la "$PTERODACTYL_DIR/" 2>/dev/null || echo "DiretÃ³rio pai nÃ£o existe"
        pause
        return 1
    fi
    
    echo -e "${GREEN}âœ… Estrutura de pastas criada${NC}"
    echo -e "${CYAN}ğŸ“‚ Verificando estrutura:${NC}"
    ls -la "$PTERODACTYL_DIR/wings/"
    
    echo -e "\n${CYAN}ğŸ“ Criando configuraÃ§Ã£o do Docker Compose...${NC}"
    
    # Criar docker-compose para o Wings
    cat > "$PTERODACTYL_DIR/wings/docker-compose.yml" << 'EOF'
version: '3.8'

services:
  wings:
    image: ghcr.io/pterodactyl/wings:latest
    restart: always
    network_mode: host
    tty: true
    environment:
      TZ: "UTC"
      WINGS_UID: 988
      WINGS_GID: 988
      WINGS_USERNAME: pterodactyl
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./data:/etc/pterodactyl"
      - "/tmp/pterodactyl:/tmp/pterodactyl"
      - "./volumes:/var/lib/pterodactyl"
    working_dir: /etc/pterodactyl
EOF

    # Verificar se o arquivo foi criado
    if [ -f "$PTERODACTYL_DIR/wings/docker-compose.yml" ]; then
        echo -e "${GREEN}âœ… docker-compose.yml criado com sucesso${NC}"
        echo -e "${CYAN}ğŸ“„ ConteÃºdo do arquivo:${NC}"
        echo -e "${WHITE}$(head -5 "$PTERODACTYL_DIR/wings/docker-compose.yml")${NC}"
        echo -e "${WHITE}... (arquivo completo)${NC}"
    else
        echo -e "${RED}âŒ Falha ao criar docker-compose.yml${NC}"
        echo -e "${YELLOW}ğŸ“‚ ConteÃºdo atual da pasta:${NC}"
        ls -la "$PTERODACTYL_DIR/wings/"
        pause
        return 1
    fi
    
    # Criar arquivo README com instruÃ§Ãµes
    cat > "$PTERODACTYL_DIR/wings/README.txt" << 'EOF'
PTERODACTYL WINGS - INSTRUÃ‡Ã•ES DE CONFIGURAÃ‡ÃƒO

1. Acesse o painel administrativo: http://localhost:8080
2. FaÃ§a login como administrador
3. VÃ¡ em "Admin" -> "Nodes" 
4. Clique em "Create New"
5. Preencha os dados do Node:
   - Name: Seu nome para o servidor
   - Location: Selecione uma localizaÃ§Ã£o
   - FQDN: localhost (ou seu domÃ­nio)
   - Communicate Over SSL: Desabilitado (para desenvolvimento local)
   - Memory: RAM disponÃ­vel em MB
   - Disk: EspaÃ§o em disco em MB
   - Daemon Port: 8080 (padrÃ£o)
6. ApÃ³s criar, clique em "Configuration"
7. Copie todo o conteÃºdo da configuraÃ§Ã£o
8. Cole no arquivo: ./data/config.yml
9. Use o menu do script para iniciar o Wings

Para criar o arquivo config.yml:
nano ./data/config.yml

Para iniciar apÃ³s configurar:
OpÃ§Ã£o 2 -> Gerenciar Pterodactyl Wings -> OpÃ§Ã£o 3 (Iniciar Wings)
EOF

    echo -e "\n${GREEN}âœ… Pterodactyl Wings instalado com sucesso!${NC}"
    echo -e "${YELLOW}ğŸ“‹ InformaÃ§Ãµes importantes:${NC}"
    echo -e "${WHITE}   â€¢ Wings preparado mas NÃƒO iniciado${NC}"
    echo -e "${WHITE}   â€¢ LocalizaÃ§Ã£o: $PTERODACTYL_DIR/wings/${NC}"
    echo -e "${WHITE}   â€¢ ConfiguraÃ§Ã£o: $PTERODACTYL_DIR/wings/data/${NC}"
    echo -e "${WHITE}   â€¢ Volumes: $PTERODACTYL_DIR/wings/volumes/${NC}"
    echo -e "${WHITE}   â€¢ InstruÃ§Ãµes: $PTERODACTYL_DIR/wings/README.txt${NC}"
    echo
    echo -e "${RED}âš ï¸  PRÃ“XIMOS PASSOS OBRIGATÃ“RIOS:${NC}"
    echo -e "${YELLOW}   1. Acesse: ${CYAN}http://localhost:8080${NC}"
    echo -e "${YELLOW}   2. Crie um Node no painel admin${NC}"
    echo -e "${YELLOW}   3. Copie a configuraÃ§Ã£o para: ${CYAN}$PTERODACTYL_DIR/wings/data/config.yml${NC}"
    echo -e "${YELLOW}   4. Use 'Gerenciar Wings' â†’ 'Iniciar Wings'${NC}"
    
    pause
}

# FunÃ§Ã£o para mostrar status
show_status() {
    show_logo
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘            ${WHITE}STATUS DOS SERVIÃ‡OS${BLUE}          â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
    
    echo -e "${CYAN}ğŸ”§ Debug - DiretÃ³rio atual: $(pwd)${NC}"
    echo -e "${CYAN}ğŸ”§ Debug - Pterodactyl DIR: $PTERODACTYL_DIR${NC}"
    echo
    
    echo -e "${CYAN}ğŸ” Verificando Pterodactyl Panel...${NC}"
    echo -e "${WHITE}   ğŸ“‚ Verificando diretÃ³rio: $PTERODACTYL_DIR/panel${NC}"
    
    if [ -d "$PTERODACTYL_DIR/panel" ]; then
        echo -e "${GREEN}   âœ… DiretÃ³rio panel encontrado${NC}"
        
        if [ -f "$PTERODACTYL_DIR/panel/docker-compose.yml" ]; then
            echo -e "${GREEN}   âœ… docker-compose.yml encontrado${NC}"
            
            # Mudar para o diretÃ³rio e verificar containers
            cd "$PTERODACTYL_DIR/panel"
            echo -e "${CYAN}   ğŸ” Verificando containers...${NC}"
            
            # Verificar se existem containers definidos
            if docker compose config --services >/dev/null 2>&1; then
                echo -e "${GREEN}   âœ… ConfiguraÃ§Ã£o docker-compose vÃ¡lida${NC}"
                
                # Verificar se estÃ£o rodando
                RUNNING=$(docker compose ps -q 2>/dev/null)
                if [ -n "$RUNNING" ]; then
                    echo -e "${GREEN}   âœ… Panel RODANDO${NC}"
                    docker compose ps --format "table {{.Service}}\t{{.Status}}" 2>/dev/null || echo "   ğŸ“Š Containers ativos detectados"
                else
                    echo -e "${YELLOW}   âš ï¸  Panel INSTALADO mas PARADO${NC}"
                fi
            elif docker-compose config --services >/dev/null 2>&1; then
                echo -e "${GREEN}   âœ… ConfiguraÃ§Ã£o docker-compose vÃ¡lida (legacy)${NC}"
                RUNNING=$(docker-compose ps -q 2>/dev/null)
                if [ -n "$RUNNING" ]; then
                    echo -e "${GREEN}   âœ… Panel RODANDO${NC}"
                    docker-compose ps --format "table {{.Service}}\t{{.Status}}" 2>/dev/null || echo "   ğŸ“Š Containers ativos detectados"
                else
                    echo -e "${YELLOW}   âš ï¸  Panel INSTALADO mas PARADO${NC}"
                fi
            else
                echo -e "${RED}   âŒ ConfiguraÃ§Ã£o docker-compose invÃ¡lida${NC}"
            fi
            cd - >/dev/null
        else
            echo -e "${RED}   âŒ docker-compose.yml NÃƒO encontrado${NC}"
            echo -e "${YELLOW}   ğŸ“‚ ConteÃºdo da pasta panel:${NC}"
            ls -la "$PTERODACTYL_DIR/panel/" 2>/dev/null || echo "   (pasta vazia ou inacessÃ­vel)"
        fi
    else
        echo -e "${RED}   âŒ DiretÃ³rio panel NÃƒO EXISTE${NC}"
    fi
    
    echo -e "\n${CYAN}ğŸ” Verificando Pterodactyl Wings...${NC}"
    echo -e "${WHITE}   ğŸ“‚ Verificando diretÃ³rio: $PTERODACTYL_DIR/wings${NC}"
    
    if [ -d "$PTERODACTYL_DIR/wings" ]; then
        echo -e "${GREEN}   âœ… DiretÃ³rio wings encontrado${NC}"
        
        if [ -f "$PTERODACTYL_DIR/wings/docker-compose.yml" ]; then
            echo -e "${GREEN}   âœ… docker-compose.yml encontrado${NC}"
            
            # Mudar para o diretÃ³rio e verificar containers
            cd "$PTERODACTYL_DIR/wings"
            echo -e "${CYAN}   ğŸ” Verificando containers...${NC}"
            
            # Verificar se existem containers definidos
            if docker compose config --services >/dev/null 2>&1; then
                echo -e "${GREEN}   âœ… ConfiguraÃ§Ã£o docker-compose vÃ¡lida${NC}"
                
                # Verificar se estÃ£o rodando
                RUNNING=$(docker compose ps -q 2>/dev/null)
                if [ -n "$RUNNING" ]; then
                    echo -e "${GREEN}   âœ… Wings RODANDO${NC}"
                    docker compose ps --format "table {{.Service}}\t{{.Status}}" 2>/dev/null || echo "   ğŸ“Š Container wings ativo"
                else
                    echo -e "${YELLOW}   âš ï¸  Wings INSTALADO mas PARADO${NC}"
                fi
            elif docker-compose config --services >/dev/null 2>&1; then
                echo -e "${GREEN}   âœ… ConfiguraÃ§Ã£o docker-compose vÃ¡lida (legacy)${NC}"
                RUNNING=$(docker-compose ps -q 2>/dev/null)
                if [ -n "$RUNNING" ]; then
                    echo -e "${GREEN}   âœ… Wings RODANDO${NC}"
                    docker-compose ps --format "table {{.Service}}\t{{.Status}}" 2>/dev/null || echo "   ğŸ“Š Container wings ativo"
                else
                    echo -e "${YELLOW}   âš ï¸  Wings INSTALADO mas PARADO${NC}"
                fi
            else
                echo -e "${RED}   âŒ ConfiguraÃ§Ã£o docker-compose invÃ¡lida${NC}"
            fi
            
            # Verificar config.yml
            if [ -f "./data/config.yml" ]; then
                echo -e "${GREEN}   âœ… config.yml encontrado${NC}"
            else
                echo -e "${YELLOW}   âš ï¸  config.yml NÃƒO encontrado${NC}"
            fi
            cd - >/dev/null
        else
            echo -e "${RED}   âŒ docker-compose.yml NÃƒO encontrado${NC}"
            echo -e "${YELLOW}   ğŸ“‚ ConteÃºdo da pasta wings:${NC}"
            ls -la "$PTERODACTYL_DIR/wings/" 2>/dev/null || echo "   (pasta vazia ou inacessÃ­vel)"
        fi
    else
        echo -e "${RED}   âŒ DiretÃ³rio wings NÃƒO EXISTE${NC}"
    fi
    
    echo -e "\n${CYAN}ğŸŒ InformaÃ§Ãµes de acesso:${NC}"
    echo -e "${WHITE}   â€¢ Panel URL: ${CYAN}http://localhost:8080${NC}"
    echo -e "${WHITE}   â€¢ DiretÃ³rio: ${CYAN}$PTERODACTYL_DIR${NC}"
    
    pause
}

# Menu de gerenciamento Panel
panel_menu() {
    while true; do
        show_logo
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘      ${WHITE}GERENCIAR PTERODACTYL PANEL${BLUE}      â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        echo -e "${WHITE}1)${NC} ${GREEN}Instalar Panel${NC}"
        echo -e "${WHITE}2)${NC} ${YELLOW}Parar Panel${NC}"
        echo -e "${WHITE}3)${NC} ${CYAN}Iniciar Panel${NC}"
        echo -e "${WHITE}4)${NC} ${PURPLE}Ver Logs${NC}"
        echo -e "${WHITE}5)${NC} ${BLUE}Criar UsuÃ¡rio Admin${NC}"
        echo -e "${WHITE}6)${NC} ${RED}Desinstalar Panel${NC}"
        echo -e "${WHITE}0)${NC} ${WHITE}Voltar ao Menu Principal${NC}"
        echo
        echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
        read -r choice
        
        case $choice in
            1) install_panel ;;
            2) 
                echo -e "${CYAN}ğŸ” Verificando se Panel estÃ¡ instalado...${NC}"
                if [ -d "$PTERODACTYL_DIR/panel" ] && [ -f "$PTERODACTYL_DIR/panel/docker-compose.yml" ]; then
                    echo -e "${CYAN}ğŸ”„ Parando Panel...${NC}"
                    cd "$PTERODACTYL_DIR/panel"
                    docker compose down 2>/dev/null || docker-compose down 2>/dev/null
                    cd - >/dev/null
                    echo -e "${GREEN}âœ… Panel parado!${NC}"
                else
                    echo -e "${RED}âŒ Panel nÃ£o encontrado ou nÃ£o instalado!${NC}"
                    echo -e "${YELLOW}ğŸ’¡ Use a opÃ§Ã£o 1 para instalar primeiro${NC}"
                fi
                pause
                ;;
            3) 
                echo -e "${CYAN}ğŸ” Verificando se Panel estÃ¡ instalado...${NC}"
                if [ -d "$PTERODACTYL_DIR/panel" ] && [ -f "$PTERODACTYL_DIR/panel/docker-compose.yml" ]; then
                    echo -e "${CYAN}ğŸ”„ Iniciando Panel...${NC}"
                    cd "$PTERODACTYL_DIR/panel"
                    docker compose up -d 2>/dev/null || docker-compose up -d 2>/dev/null
                    cd - >/dev/null
                    sleep 3
                    echo -e "${GREEN}âœ… Panel iniciado!${NC}"
                    echo -e "${CYAN}ğŸŒ Acesse: http://localhost:8080${NC}"
                else
                    echo -e "${RED}âŒ Panel nÃ£o encontrado ou nÃ£o instalado!${NC}"
                    echo -e "${YELLOW}ğŸ’¡ Use a opÃ§Ã£o 1 para instalar primeiro${NC}"
                fi
                pause
                ;;
            4) 
                echo -e "${CYAN}ğŸ” Verificando se Panel estÃ¡ instalado...${NC}"
                if [ -d "$PTERODACTYL_DIR/panel" ] && [ -f "$PTERODACTYL_DIR/panel/docker-compose.yml" ]; then
                    echo -e "${CYAN}ğŸ“‹ Mostrando logs do Panel... (Ctrl+C para sair)${NC}"
                    cd "$PTERODACTYL_DIR/panel"
                    docker compose logs -f 2>/dev/null || docker-compose logs -f 2>/dev/null
                    cd - >/dev/null
                else
                    echo -e "${RED}âŒ Panel nÃ£o encontrado ou nÃ£o instalado!${NC}"
                    echo -e "${YELLOW}ğŸ’¡ Use a opÃ§Ã£o 1 para instalar primeiro${NC}"
                    pause
                fi
                ;;
            5) create_admin_user ;;
            6) 
                echo -e "${RED}âš ï¸  Tem certeza que deseja desinstalar o Panel? (y/N): ${NC}"
                read -r confirm
                if [[ $confirm =~ ^[Yy]$ ]]; then
                    if [ -d "$PTERODACTYL_DIR/panel" ]; then
                        echo -e "${CYAN}ğŸ”„ Parando e removendo containers...${NC}"
                        cd "$PTERODACTYL_DIR/panel"
                        docker compose down -v 2>/dev/null || docker-compose down -v 2>/dev/null
                        cd - >/dev/null
                        echo -e "${CYAN}ğŸ—‘ï¸ Removendo arquivos...${NC}"
                        rm -rf "$PTERODACTYL_DIR/panel"
                        echo -e "${GREEN}âœ… Panel desinstalado!${NC}"
                    else
                        echo -e "${RED}âŒ Panel nÃ£o encontrado!${NC}"
                    fi
                else
                    echo -e "${YELLOW}âŒ OperaÃ§Ã£o cancelada.${NC}"
                fi
                pause
                ;;
            0) break ;;
            *) 
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
                sleep 1
                ;;
        esac
    done
}

# Menu de gerenciamento Wings
wings_menu() {
    while true; do
        show_logo
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘       ${WHITE}GERENCIAR PTERODACTYL WINGS${BLUE}      â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        echo -e "${WHITE}1)${NC} ${GREEN}Instalar Wings${NC}"
        echo -e "${WHITE}2)${NC} ${YELLOW}Parar Wings${NC}"
        echo -e "${WHITE}3)${NC} ${CYAN}Iniciar Wings${NC}"
        echo -e "${WHITE}4)${NC} ${PURPLE}Ver Logs${NC}"
        echo -e "${WHITE}5)${NC} ${RED}Desinstalar Wings${NC}"
        echo -e "${WHITE}0)${NC} ${WHITE}Voltar ao Menu Principal${NC}"
        echo
        echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
        read -r choice
        
        case $choice in
            1) install_wings ;;
            2) 
                echo -e "${CYAN}ğŸ” Verificando se Wings estÃ¡ instalado...${NC}"
                if [ -d "$PTERODACTYL_DIR/wings" ] && [ -f "$PTERODACTYL_DIR/wings/docker-compose.yml" ]; then
                    echo -e "${CYAN}ğŸ”„ Parando Wings...${NC}"
                    cd "$PTERODACTYL_DIR/wings"
                    docker compose down 2>/dev/null || docker-compose down 2>/dev/null
                    cd - >/dev/null
                    echo -e "${GREEN}âœ… Wings parado!${NC}"
                else
                    echo -e "${RED}âŒ Wings nÃ£o encontrado ou nÃ£o instalado!${NC}"
                    echo -e "${YELLOW}ğŸ’¡ Use a opÃ§Ã£o 1 para instalar primeiro${NC}"
                fi
                pause
                ;;
            3) 
                echo -e "${CYAN}ğŸ” Verificando se Wings estÃ¡ instalado...${NC}"
                if [ -d "$PTERODACTYL_DIR/wings" ] && [ -f "$PTERODACTYL_DIR/wings/docker-compose.yml" ]; then
                    # Verificar se config.yml existe antes de iniciar
                    if [ ! -f "$PTERODACTYL_DIR/wings/data/config.yml" ]; then
                        echo -e "${RED}âŒ Arquivo config.yml nÃ£o encontrado!${NC}"
                        echo -e "${YELLOW}ğŸ“‹ Para iniciar o Wings vocÃª precisa:${NC}"
                        echo -e "${WHITE}   1. Acessar o painel: ${CYAN}http://localhost:8080${NC}"
                        echo -e "${WHITE}   2. Ir em Admin â†’ Nodes${NC}"
                        echo -e "${WHITE}   3. Criar um novo Node${NC}"
                        echo -e "${WHITE}   4. Copiar a configuraÃ§Ã£o gerada${NC}"
                        echo -e "${WHITE}   5. Salvar como: ${CYAN}$PTERODACTYL_DIR/wings/data/config.yml${NC}"
                        echo
                        echo -e "${CYAN}ğŸ’¡ Exemplo de comando para criar o arquivo:${NC}"
                        echo -e "${WHITE}   nano $PTERODACTYL_DIR/wings/data/config.yml${NC}"
                        echo -e "${WHITE}   ou${NC}"
                        echo -e "${WHITE}   cat > $PTERODACTYL_DIR/wings/data/config.yml${NC}"
                        echo -e "${WHITE}   (cole a configuraÃ§Ã£o e pressione Ctrl+D)${NC}"
                        echo
                        echo -e "${YELLOW}Deseja continuar mesmo assim? (y/N): ${NC}"
                        read -r confirm
                        if [[ ! $confirm =~ ^[Yy]$ ]]; then
                            pause
                            continue
                        fi
                    fi
                    
                    echo -e "${CYAN}ğŸ”„ Iniciando Wings...${NC}"
                    cd "$PTERODACTYL_DIR/wings"
                    docker compose up -d 2>/dev/null || docker-compose up -d 2>/dev/null
                    
                    sleep 3
                    
                    # Verificar se iniciou com sucesso
                    RUNNING=$(docker compose ps -q 2>/dev/null || docker-compose ps -q 2>/dev/null)
                    if [ -n "$RUNNING" ]; then
                        echo -e "${GREEN}âœ… Wings iniciado com sucesso!${NC}"
                        if [ -f "./data/config.yml" ]; then
                            echo -e "${GREEN}âœ… Configurado e funcionando${NC}"
                        else
                            echo -e "${YELLOW}âš ï¸  Iniciado mas sem configuraÃ§Ã£o vÃ¡lida${NC}"
                            echo -e "${YELLOW}âš ï¸  O Wings pode nÃ£o funcionar corretamente${NC}"
                        fi
                    else
                        echo -e "${RED}âŒ Erro ao iniciar Wings${NC}"
                        echo -e "${YELLOW}ğŸ“‹ Verificando logs...${NC}"
                        docker compose logs --tail=10 2>/dev/null || docker-compose logs --tail=10 2>/dev/null
                    fi
                    cd - >/dev/null
                else
                    echo -e "${RED}âŒ Wings nÃ£o encontrado ou nÃ£o instalado!${NC}"
                    echo -e "${YELLOW}ğŸ’¡ Use a opÃ§Ã£o 1 para instalar primeiro${NC}"
                fi
                pause
                ;;
            4) 
                echo -e "${CYAN}ğŸ” Verificando se Wings estÃ¡ instalado...${NC}"
                if [ -d "$PTERODACTYL_DIR/wings" ] && [ -f "$PTERODACTYL_DIR/wings/docker-compose.yml" ]; then
                    echo -e "${CYAN}ğŸ“‹ Mostrando logs do Wings... (Ctrl+C para sair)${NC}"
                    cd "$PTERODACTYL_DIR/wings"
                    docker compose logs -f 2>/dev/null || docker-compose logs -f 2>/dev/null
                    cd - >/dev/null
                else
                    echo -e "${RED}âŒ Wings nÃ£o encontrado ou nÃ£o instalado!${NC}"
                    echo -e "${YELLOW}ğŸ’¡ Use a opÃ§Ã£o 1 para instalar primeiro${NC}"
                    pause
                fi
                ;;
            5) 
                echo -e "${RED}âš ï¸  Tem certeza que deseja desinstalar o Wings? (y/N): ${NC}"
                read -r confirm
                if [[ $confirm =~ ^[Yy]$ ]]; then
                    if [ -d "$PTERODACTYL_DIR/wings" ]; then
                        echo -e "${CYAN}ğŸ”„ Parando e removendo containers...${NC}"
                        cd "$PTERODACTYL_DIR/wings"
                        docker compose down -v 2>/dev/null || docker-compose down -v 2>/dev/null
                        cd - >/dev/null
                        echo -e "${CYAN}ğŸ—‘ï¸ Removendo arquivos...${NC}"
                        rm -rf "$PTERODACTYL_DIR/wings"
                        echo -e "${GREEN}âœ… Wings desinstalado!${NC}"
                    else
                        echo -e "${RED}âŒ Wings nÃ£o encontrado!${NC}"
                    fi
                else
                    echo -e "${YELLOW}âŒ OperaÃ§Ã£o cancelada.${NC}"
                fi
                pause
                ;;
            0) break ;;
            *) 
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida!${NC}"
                sleep 1
                ;;
        esac
    done
}

# Menu principal
main_menu() {
    while true; do
        show_logo
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘            ${WHITE}MENU PRINCIPAL${BLUE}               â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        echo -e "${WHITE}1)${NC} ${GREEN}Gerenciar Pterodactyl Panel${NC}"
        echo -e "${WHITE}2)${NC} ${CYAN}Gerenciar Pterodactyl Wings${NC}"
        echo -e "${WHITE}3)${NC} ${YELLOW}Status dos ServiÃ§os${NC}"
        echo -e "${WHITE}4)${NC} ${PURPLE}Instalar Tudo (Panel + Wings)${NC}"
        echo -e "${WHITE}0)${NC} ${RED}Sair${NC}"
        echo
        echo -ne "${YELLOW}Escolha uma opÃ§Ã£o: ${NC}"
        read -r choice
        
        case $choice in
            1) panel_menu ;;
            2) wings_menu ;;
            3) show_status ;;
            4) 
                echo -e "${CYAN}ğŸš€ Instalando Panel e Wings...${NC}"
                install_panel
                install_wings
                show_status
                ;;
            0) 
                echo -e "\n${GREEN}ğŸ‘‹ Obrigado por usar o Eric-One-Click!${NC}"
                echo -e "${CYAN}   Desenvolvido com â¤ï¸  para a comunidade Pterodactyl${NC}"
                exit 0
                ;;
            *) 
                echo -e "${RED}OpÃ§Ã£o invÃ¡lida! Tente novamente.${NC}"
                sleep 1
                ;;
        esac
    done
}

# FunÃ§Ã£o principal
main() {
    # Verificar dependÃªncias e configurar diretÃ³rios
    check_requirements
    
    # Mostrar menu principal
    main_menu
}

# Executar script
main "$@"
