#!/bin/bash
set -e

echo "ğŸš€ Configurando Pterodactyl Wings para CodeSandbox..."

# Criar estrutura de diretÃ³rios
mkdir -p pterodactyl/wings/{config,data,logs,tmp}
cd pterodactyl/wings



# Criar docker-compose.yml adaptado para CodeSandbox
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  wings:
    image: ghcr.io/pterodactyl/wings:latest
    restart: unless-stopped
    networks:
      - wings
    ports:
      - "8080:8080"
      - "2022:2022"
      - "443:443"
    tty: true
    environment:
      TZ: "UTC"
      WINGS_UID: 988
      WINGS_GID: 988
    volumes:
      # Wings config (serÃ¡ criado automaticamente ou montado via painel)
      # - "./config:/etc/pterodactyl"
      # Docker socket (para CodeSandbox pode precisar de ajustes)
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      # Wings data
      - "./data:/var/lib/pterodactyl/volumes"
      - "./logs:/var/log/pterodactyl"
      - "./tmp:/tmp/pterodactyl"
      # Docker logs
      - "/var/lib/docker/containers:/var/lib/docker/containers:ro"
    privileged: true

  # Simulador de Docker (para ambiente CodeSandbox)
  docker-in-docker:
    image: docker:dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    volumes:
      - "docker-data:/var/lib/docker"
    networks:
      - wings
    ports:
      - "2376:2376"

  # Web interface para monitoramento (opcional)
  portainer:
    image: portainer/portainer-ce:latest
    restart: unless-stopped
    ports:
      - "9000:9000"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "portainer-data:/data"
    networks:
      - wings

volumes:
  docker-data:
  portainer-data:

networks:
  wings:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.18.0.0/16
EOF

# Criar script de configuraÃ§Ã£o inicial
cat > setup.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸ”§ Configurando Wings..."

# Verificar se Docker estÃ¡ disponÃ­vel
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker nÃ£o encontrado. Instalando..."
    # Para CodeSandbox, pode ser necessÃ¡rio usar docker-in-docker
    echo "â„¹ï¸  No CodeSandbox, use o serviÃ§o docker-in-docker"
fi

# Criar rede do Docker
echo "ğŸ“¡ Criando rede pterodactyl_nw..."
docker network create pterodactyl_nw --driver=bridge --subnet=172.18.0.0/16 --gateway=172.18.0.1 2>/dev/null || echo "Rede jÃ¡ existe"

# Definir permissÃµes
echo "ğŸ”’ Configurando permissÃµes..."
sudo chown -R 988:988 ./data ./logs ./tmp 2>/dev/null || echo "PermissÃµes configuradas (se disponÃ­vel)"

echo "âœ… ConfiguraÃ§Ã£o inicial concluÃ­da!"
echo ""
echo "ğŸ“ PrÃ³ximos passos:"
echo "1. Edite config-example.yml e renomeie para ./config/config.yml"
echo "2. Ou use: ./auto-configure.sh <PANEL_URL> <UUID> <TOKEN_ID> <TOKEN>"
echo "3. Execute: docker-compose up -d"
echo "4. Acesse http://localhost:9000 para o Portainer (opcional)"
EOF



# Criar README para CodeSandbox
cat > README.md << 'EOF'
# Pterodactyl Wings - Setup para CodeSandbox

Este setup configura o Pterodactyl Wings (daemon) para funcionar em ambiente CodeSandbox.

## ğŸš€ InÃ­cio RÃ¡pido

1. **Configurar Wings:**
   ```bash
   chmod +x setup.sh configure-example.sh
   ./setup.sh
   ```

2. **Configurar Wings:**
   - Copie `config-example.yml` para `config/config.yml` e edite
   - Ou use o script automÃ¡tico: `./auto-configure.sh <URL> <UUID> <TOKEN_ID> <TOKEN>`

3. **Iniciar serviÃ§os:**
   ```bash
   docker-compose up -d
   ```

## ğŸ“‹ ServiÃ§os DisponÃ­veis

- **Wings API**: http://localhost:8080
- **SFTP**: localhost:2022
- **Portainer**: http://localhost:9000 (interface web para Docker)

## âš™ï¸ ConfiguraÃ§Ã£o

### Dados necessÃ¡rios do Painel:
- UUID do Wings
- Token ID
- Token
- URL do painel

### Portas utilizadas:
- 8080: Wings API
- 2022: SFTP
- 9000: Portainer (opcional)
- 443: SSL (se habilitado)

## ğŸ”§ Problemas Conhecidos no CodeSandbox

1. **Docker Socket**: Pode ser necessÃ¡rio usar docker-in-docker
2. **PermissÃµes**: Algumas operaÃ§Ãµes privilegiadas podem nÃ£o funcionar
3. **Networking**: LimitaÃ§Ãµes de rede do ambiente sandbox

## ğŸ“ Comandos Ãšteis

```bash
# Ver logs do Wings
docker-compose logs -f wings

# Reiniciar Wings
docker-compose restart wings

# Parar todos os serviÃ§os
docker-compose down

# Ver status dos containers
docker-compose ps
```

## ğŸ› Debug

- Verifique os logs em `./logs/`
- Use `docker-compose logs wings` para debug
- Portainer oferece interface grÃ¡fica para gerenciar containers
EOF

# Tornar scripts executÃ¡veis
chmod +x setup.sh

echo ""
echo "ğŸ‰ Setup do Pterodactyl Wings criado com sucesso!"
echo ""
echo "ğŸ“ Estrutura criada:"
echo "  pterodactyl/wings/"
echo "  â”œâ”€â”€ config-example.yml     # Template de configuraÃ§Ã£o"
echo "  â”œâ”€â”€ docker-compose.yml     # ServiÃ§os Docker"
echo "  â”œâ”€â”€ setup.sh               # Script de configuraÃ§Ã£o inicial"
echo "  â”œâ”€â”€ auto-configure.sh      # Script de configuraÃ§Ã£o automÃ¡tica"
echo "  â””â”€â”€ README.md              # DocumentaÃ§Ã£o"
echo ""
echo "ğŸ“ PrÃ³ximos passos:"
echo "1. cd pterodactyl/wings"
echo "2. ./setup.sh"
echo "3. ./auto-configure.sh <PANEL_URL> <UUID> <TOKEN_ID> <TOKEN>"
echo "4. docker-compose up -d"
echo ""
echo "â„¹ï¸  Para CodeSandbox, pode ser necessÃ¡rio ajustar as configuraÃ§Ãµes"
echo "   de Docker devido Ã s limitaÃ§Ãµes do ambiente sandbox."
